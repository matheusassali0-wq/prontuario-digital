<!doctype html>
<html lang="pt-BR">
  <head>
    `r`n
    <meta name="csrf-token" content="" />
    `r`n
    <meta name="active-patient-id" content="" />
    `r`n
    <meta name="crm-number" content="CRM_SP_210257" />
    `r`n
    <meta name="doctor-id" content="DR_MATHEUS_ASSALI" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Prontuário Digital - Dr. Matheus Jorge Assali</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome Icons -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      /* CSS Variables for Design System */
      :root {
        /* Primary Colors */
        --primary-50: #eff6ff;
        --primary-100: #dbeafe;
        --primary-200: #bfdbfe;
        --primary-300: #93c5fd;
        --primary-400: #60a5fa;
        --primary-500: #3b82f6;
        --primary-600: #2563eb;
        --primary-700: #1d4ed8;
        --primary-800: #1e40af;
        --primary-900: #1e3a8a;

        /* Gray Scale */
        --gray-50: #f8fafc;
        --gray-100: #f1f5f9;
        --gray-200: #e2e8f0;
        --gray-300: #cbd5e1;
        --gray-400: #94a3b8;
        --gray-500: #64748b;
        --gray-600: #475569;
        --gray-700: #334155;
        --gray-800: #1e293b;
        --gray-900: #0f172a;

        /* Success Colors */
        --success-50: #ecfdf5;
        --success-500: #10b981;
        --success-700: #047857;

        /* Warning Colors */
        --warning-50: #fffbeb;
        --warning-500: #f59e0b;
        --warning-700: #b45309;

        /* Error Colors */
        --error-50: #fef2f2;
        --error-500: #ef4444;
        --error-700: #c53030;

        /* Shadows */
        --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        --shadow-md:
          0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg:
          0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --shadow-xl:
          0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

        /* Border Radius */
        --radius: 0.5rem;
        --radius-lg: 1rem;
        --radius-xl: 1.5rem;

        /* Transitions */
        --transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* Reset and Base Styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          "Inter",
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
        background-color: var(--gray-50);
        color: var(--gray-900);
        line-height: 1.5;
        font-size: 14px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Layout Components */
      .app-container {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        background: linear-gradient(
          135deg,
          var(--primary-700) 0%,
          var(--primary-900) 100%
        );
        color: white;
        padding: 1.5rem 2rem;
        box-shadow: var(--shadow-lg);
        position: sticky;
        top: 0;
        z-index: 50;
        border-bottom: 1px solid var(--primary-800);
      }

      .header-content {
        max-width: 1600px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 2rem;
      }

      .header-brand {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .header-title {
        font-size: 1.5rem;
        font-weight: 800;
        letter-spacing: -0.025em;
        line-height: 1;
      }

      .header-subtitle {
        font-size: 0.875rem;
        opacity: 0.9;
        font-weight: 500;
      }

      .header-meta {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }

      .status-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255, 255, 255, 0.15);
        padding: 0.5rem 1rem;
        border-radius: var(--radius-lg);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .status-dot {
        width: 6px;
        height: 6px;
        background: var(--success-500);
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }

        50% {
          opacity: 0.6;
        }
      }

      .system-info {
        font-size: 0.75rem;
        opacity: 0.8;
        font-weight: 500;
      }

      .main-content {
        flex: 1;
        max-width: 1600px;
        margin: 0 auto;
        width: 100%;
        padding: 2rem;
      }

      /* Navigation */
      .navigation {
        display: flex;
        gap: 0.25rem;
        margin-bottom: 2rem;
        background: white;
        padding: 0.5rem;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        overflow-x: auto;
      }

      .nav-tab {
        flex: 1;
        min-width: 120px;
        padding: 0.875rem 1.25rem;
        background: transparent;
        border: none;
        border-radius: var(--radius-lg);
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--gray-600);
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        white-space: nowrap;
      }

      .nav-tab:hover {
        background: var(--gray-100);
        color: var(--gray-800);
      }

      .nav-tab.active {
        background: var(--primary-600);
        color: white;
        box-shadow: var(--shadow-md);
      }

      .nav-tab i {
        font-size: 1rem;
      }

      /* Sections */
      .section {
        display: none;
      }

      .section.active {
        display: block;
        animation: fadeInUp 0.4s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Dashboard */
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .metric-card {
        background: white;
        padding: 1.5rem;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }

      .metric-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(
          90deg,
          var(--primary-500),
          var(--primary-700)
        );
      }

      .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .metric-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
      }

      .metric-data {
        flex: 1;
      }

      .metric-value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--gray-900);
        margin-bottom: 0.25rem;
        line-height: 1;
      }

      .metric-label {
        font-size: 0.875rem;
        color: var(--gray-600);
        font-weight: 500;
      }

      .metric-change {
        font-size: 0.75rem;
        margin-top: 0.5rem;
        font-weight: 600;
      }

      .metric-change.positive {
        color: var(--success-700);
      }

      .metric-change.negative {
        color: var(--error-700);
      }

      .metric-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        flex-shrink: 0;
      }

      .metric-icon.primary {
        background: var(--primary-100);
        color: var(--primary-700);
      }

      .metric-icon.success {
        background: var(--success-50);
        color: var(--success-700);
      }

      .metric-icon.warning {
        background: var(--warning-50);
        color: var(--warning-700);
      }

      .metric-icon.error {
        background: var(--error-50);
        color: var(--error-700);
      }

      /* Cards */
      .card {
        background: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        overflow: hidden;
        transition: var(--transition);
      }

      .card:hover {
        box-shadow: var(--shadow-lg);
      }

      .card-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--gray-200);
        background: var(--gray-50);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .card-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--gray-900);
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .card-body {
        padding: 2rem;
      }

      /* Search */
      .search-section {
        margin-bottom: 2rem;
      }

      .search-container {
        position: relative;
      }

      .search-input {
        width: 100%;
        padding: 1rem 1rem 1rem 3rem;
        border: 2px solid var(--gray-300);
        border-radius: var(--radius-lg);
        font-size: 1rem;
        background: white;
        transition: var(--transition);
        font-weight: 500;
      }

      .search-input:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px var(--primary-100);
      }

      .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-400);
        font-size: 1.125rem;
      }

      .search-results-count {
        margin-top: 0.75rem;
        font-size: 0.875rem;
        color: var(--gray-500);
        font-weight: 500;
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--radius-lg);
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        white-space: nowrap;
        position: relative;
        overflow: hidden;
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s ease;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn.primary {
        background: var(--primary-600);
        color: white;
      }

      .btn.primary:hover:not(:disabled) {
        background: var(--primary-700);
        transform: translateY(-1px);
        box-shadow: var(--shadow-lg);
      }

      .btn.secondary {
        background: white;
        color: var(--gray-700);
        border: 2px solid var(--gray-300);
      }

      .btn.secondary:hover:not(:disabled) {
        background: var(--gray-50);
        border-color: var(--gray-400);
      }

      .btn.success {
        background: var(--success-500);
        color: white;
      }

      .btn.success:hover:not(:disabled) {
        background: var(--success-700);
      }

      .btn.warning {
        background: var(--warning-500);
        color: white;
      }

      .btn.warning:hover:not(:disabled) {
        background: var(--warning-700);
      }

      .btn.danger {
        background: var(--error-500);
        color: white;
      }

      .btn.danger:hover:not(:disabled) {
        background: var(--error-700);
      }

      .btn.sm {
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
      }

      .btn.lg {
        padding: 1rem 2rem;
        font-size: 1rem;
      }

      .btn.loading {
        position: relative;
      }

      .btn.loading::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        border: 2px solid transparent;
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .btn.loading i,
      .btn.loading span {
        opacity: 0;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Patient Cards */
      .patient-grid {
        display: grid;
        gap: 1rem;
      }

      .patient-card {
        background: white;
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-xl);
        padding: 1.5rem;
        transition: var(--transition);
        cursor: pointer;
      }

      .patient-card:hover {
        border-color: var(--primary-300);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }

      .patient-card.selected {
        border-color: var(--primary-500);
        background: var(--primary-50);
      }

      .patient-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .patient-avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: var(--primary-100);
        color: var(--primary-700);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 1.25rem;
        flex-shrink: 0;
      }

      .patient-info {
        flex: 1;
      }

      .patient-name {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 0.25rem;
      }

      .patient-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.875rem;
        color: var(--gray-600);
        flex-wrap: wrap;
      }

      .patient-meta span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }

      .patient-status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .patient-status.active {
        background: var(--success-50);
        color: var(--success-700);
      }

      .patient-status.inactive {
        background: var(--error-50);
        color: var(--error-700);
      }

      .patient-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        margin-top: 1rem;
      }

      /* Forms */
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-label {
        display: block;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
      }

      .form-control {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--gray-300);
        border-radius: var(--radius-lg);
        font-size: 0.875rem;
        transition: var(--transition);
        background: white;
        font-weight: 500;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px var(--primary-100);
      }

      .form-control.error {
        border-color: var(--error-500);
      }

      .form-error {
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: var(--error-700);
        font-weight: 500;
      }

      /* Editor */
      .editor-container {
        position: relative;
      }

      .medical-editor {
        min-height: 400px;
        padding: 1.5rem;
        border: 2px solid var(--gray-300);
        border-radius: var(--radius-lg);
        font-family: "JetBrains Mono", "Monaco", "Consolas", monospace;
        font-size: 0.875rem;
        line-height: 1.6;
        resize: vertical;
        background: white;
        transition: var(--transition);
      }

      .medical-editor:focus {
        outline: none;
        border-color: var(--primary-500);
        box-shadow: 0 0 0 3px var(--primary-100);
      }

      .template-actions {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
      }

      .editor-toolbar {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: var(--gray-50);
        border-radius: var(--radius-lg);
        border: 1px solid var(--gray-200);
      }

      /* Modals */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
        padding: 1rem;
      }

      .modal-overlay.show {
        display: flex;
        animation: fadeIn 0.2s ease-out;
      }

      .modal {
        background: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        transform: scale(0.95);
        transition: transform 0.2s ease-out;
      }

      .modal-overlay.show .modal {
        transform: scale(1);
      }

      .modal-header {
        padding: 2rem 2rem 1rem;
        border-bottom: 1px solid var(--gray-200);
      }

      .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
      }

      .modal-body {
        padding: 2rem;
      }

      .modal-footer {
        padding: 1rem 2rem 2rem;
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
      }

      /* Alerts */
      .alert {
        padding: 1rem 1.5rem;
        border-radius: var(--radius-lg);
        border: 1px solid;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .alert.success {
        background: var(--success-50);
        border-color: var(--success-500);
        color: var(--success-700);
      }

      .alert.warning {
        background: var(--warning-50);
        border-color: var(--warning-500);
        color: var(--warning-700);
      }

      .alert.error {
        background: var(--error-50);
        border-color: var(--error-500);
        color: var(--error-700);
      }

      .alert.info {
        background: var(--primary-50);
        border-color: var(--primary-500);
        color: var(--primary-700);
      }

      /* Toast Notifications */
      .toast {
        position: fixed;
        top: 1rem;
        right: 1rem;
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        border: 1px solid var(--gray-200);
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        z-index: 1000;
        max-width: 400px;
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .toast.show {
        transform: translateX(0);
      }

      .toast-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        color: white;
        flex-shrink: 0;
      }

      .toast.success .toast-icon {
        background: var(--success-500);
      }

      .toast.error .toast-icon {
        background: var(--error-500);
      }

      .toast.warning .toast-icon {
        background: var(--warning-500);
      }

      .toast.info .toast-icon {
        background: var(--primary-500);
      }

      .toast-content {
        flex: 1;
      }

      .toast-message {
        font-size: 0.875rem;
        color: var(--gray-600);
      }

      /* Loading States */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid var(--gray-300);
        border-radius: 50%;
        border-top-color: var(--primary-600);
        animation: spin 1s linear infinite;
      }

      .loading-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--gray-500);
      }

      .loading-state .loading-spinner {
        width: 32px;
        height: 32px;
        margin-bottom: 1rem;
      }

      .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--gray-500);
      }

      .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      .empty-state h3 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--gray-700);
      }

      .empty-state p {
        font-size: 0.875rem;
        margin-bottom: 2rem;
      }

      /* Quick Actions */
      .quick-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 2rem;
      }

      /* Responsive Design */
      @media (max-width: 1024px) {
        .header-content {
          grid-template-columns: 1fr;
          text-align: center;
        }

        .main-content {
          padding: 1.5rem;
        }

        .dashboard-grid {
          grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        }
      }

      @media (max-width: 768px) {
        .main-content {
          padding: 1rem;
        }

        .navigation {
          flex-direction: column;
          gap: 0.5rem;
        }

        .nav-tab {
          justify-content: flex-start;
        }

        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .form-grid {
          grid-template-columns: 1fr;
        }

        .patient-header {
          flex-direction: column;
          text-align: center;
        }

        .patient-actions {
          justify-content: center;
        }

        .modal {
          margin: 1rem;
          max-width: none;
        }

        .template-actions {
          justify-content: center;
        }

        .quick-actions {
          justify-content: center;
        }
      }

      /* Dark Mode Support */
      @media (prefers-color-scheme: dark) {
        :root {
          --gray-50: #0f172a;
          --gray-100: #1e293b;
          --gray-200: #334155;
          --gray-300: #475569;
          --gray-400: #64748b;
          --gray-500: #94a3b8;
          --gray-600: #cbd5e1;
          --gray-700: #e2e8f0;
          --gray-800: #f1f5f9;
          --gray-900: #f8fafc;
        }
      }

      /* Print Styles */
      @media print {
        .header,
        .navigation,
        .patient-actions,
        .modal-overlay {
          display: none !important;
        }

        .main-content {
          padding: 0;
          max-width: none;
        }

        .card {
          box-shadow: none;
          border: 1px solid var(--gray-300);
        }
      }
    </style>
  </head>

  <body>
    <div class="app-container">
      <!-- Header Section -->
      <header class="header">
        `r`n <meta name="csrf-token" content="" />`r`n
        <meta name="active-patient-id" content="" />`r`n
        <meta name="crm-number" content="CRM_SP_210257" />`r`n
        <meta name="doctor-id" content="DR_MATHEUS_ASSALI" />
        <div class="header-content">
          <div class="header-brand">
            <h1 class="header-title">Prontuário Digital</h1>
            <div class="header-subtitle">
              Dr. Matheus Jorge Assali • Nefrologia
            </div>
          </div>
          <div class="header-meta">
            <div class="status-badge">
              <div class="status-dot"></div>
              <span>Sistema Online</span>
            </div>
            <div class="system-info" id="systemInfo">v4.0.0 Professional</div>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Navigation Tabs -->
        <nav class="navigation" role="navigation">
          <button class="nav-tab active" data-section="dashboard">
            <i class="fas fa-chart-line" aria-hidden="true"></i>
            <span>Dashboard</span>
          </button>
          <button class="nav-tab" data-section="patients">
            <i class="fas fa-users" aria-hidden="true"></i>
            <span>Pacientes</span>
          </button>
          <button class="nav-tab" data-section="records">
            <i class="fas fa-file-medical" aria-hidden="true"></i>
            <span>Prontuários</span>
          </button>
          <button class="nav-tab" data-section="prescriptions">
            <i class="fas fa-prescription-bottle" aria-hidden="true"></i>
            <span>Prescrições</span>
          </button>
          <button class="nav-tab" data-section="settings">
            <i class="fas fa-cog" aria-hidden="true"></i>
            <span>Configurações</span>
          </button>
        </nav>

        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
          <div class="dashboard-grid">
            <!-- Total Patients Metric -->
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-data">
                  <div class="metric-value" id="totalPatients">0</div>
                  <div class="metric-label">Total de Pacientes</div>
                  <div class="metric-change positive" id="patientsChange">
                    +0 este mês
                  </div>
                </div>
                <div class="metric-icon primary">
                  <i class="fas fa-users" aria-hidden="true"></i>
                </div>
              </div>
            </div>

            <!-- Today's Consultations -->
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-data">
                  <div class="metric-value" id="todayConsultations">0</div>
                  <div class="metric-label">Consultas Hoje</div>
                  <div class="metric-change positive" id="consultationsChange">
                    Agenda atualizada
                  </div>
                </div>
                <div class="metric-icon success">
                  <i class="fas fa-stethoscope" aria-hidden="true"></i>
                </div>
              </div>
            </div>

            <!-- Active Prescriptions -->
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-data">
                  <div class="metric-value" id="activePrescriptions">0</div>
                  <div class="metric-label">Prescrições Ativas</div>
                  <div class="metric-change" id="prescriptionsChange">
                    Sistema integrado
                  </div>
                </div>
                <div class="metric-icon warning">
                  <i class="fas fa-pills" aria-hidden="true"></i>
                </div>
              </div>
            </div>

            <!-- Bird ID Status -->
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-data">
                  <div class="metric-value" id="birdIdStatus">-</div>
                  <div class="metric-label">Status Bird ID</div>
                  <div class="metric-change" id="birdIdChange">
                    Verificando...
                  </div>
                </div>
                <div class="metric-icon" id="birdIdIcon">
                  <i class="fas fa-certificate" aria-hidden="true"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Actions Card -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">
                <i class="fas fa-bolt" aria-hidden="true"></i>
                Ações Rápidas
              </h2>
            </div>
            <div class="card-body">
              <div class="quick-actions">
                <button class="btn primary" onclick="app.showAddPatientModal()">
                  <i class="fas fa-user-plus" aria-hidden="true"></i>
                  Novo Paciente
                </button>
                <button
                  class="btn secondary"
                  onclick="app.refreshDashboard(event)"
                >
                  <i class="fas fa-sync-alt" aria-hidden="true"></i>
                  Atualizar Dados
                </button>
                <button class="btn success" onclick="app.openQuickSearch()">
                  <i class="fas fa-search" aria-hidden="true"></i>
                  Busca Rápida
                </button>
                <button class="btn warning" onclick="app.openAnalytics()">
                  <i class="fas fa-chart-bar" aria-hidden="true"></i>
                  Ver Analytics
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- Patients Section -->
        <section id="patients" class="section">
          <div class="search-section">
            <div class="search-container">
              <i class="fas fa-search search-icon" aria-hidden="true"></i>
              <input
                type="text"
                class="search-input"
                id="patientSearch"
                placeholder="Buscar pacientes por nome, CPF, telefone, convênio..."
                aria-label="Buscar pacientes"
              />
            </div>
            <div class="search-results-count" id="searchResultsCount"></div>
          </div>

          <div class="card">
            <div class="card-header">
              <h2 class="card-title">
                <i class="fas fa-users" aria-hidden="true"></i>
                Pacientes Cadastrados
              </h2>
              <button class="btn primary" onclick="app.showAddPatientModal()">
                <i class="fas fa-plus" aria-hidden="true"></i>
                Novo Paciente
              </button>
            </div>
            <div class="card-body">
              <div id="patientsContainer">
                <div class="loading-state">
                  <div class="loading-spinner"></div>
                  <p>Carregando pacientes...</p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Medical Records Section -->
        <section id="records" class="section">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">
                <i class="fas fa-file-medical" aria-hidden="true"></i>
                Nova Evolução Médica
              </h2>
            </div>
            <div class="card-body">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label" for="recordPatientId"
                    >ID do Paciente</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="recordPatientId"
                    placeholder="Digite o ID do paciente"
                    aria-describedby="recordPatientIdHelp"
                  />
                  <div
                    id="recordPatientIdHelp"
                    class="form-error"
                    style="display: none"
                  ></div>
                </div>
                <div class="form-group">
                  <label class="form-label" for="recordType"
                    >Tipo de Consulta</label
                  >
                  <select class="form-control" id="recordType">
                    <option value="primeira_consulta">
                      Primeira Consulta Nefrológica
                    </option>
                    <option value="retorno">Consulta de Retorno</option>
                    <option value="intercorrencia">Intercorrência</option>
                    <option value="evolucao_hd">Evolução Hemodiálise</option>
                    <option value="evolucao_dp">
                      Evolução Diálise Peritoneal
                    </option>
                    <option value="pre_transplante">
                      Avaliação Pré-Transplante
                    </option>
                    <option value="pos_transplante">
                      Seguimento Pós-Transplante
                    </option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label" for="recordDate"
                    >Data e Hora da Consulta</label
                  >
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="recordDate"
                  />
                </div>
              </div>

              <div class="template-actions">
                <button
                  class="btn secondary sm"
                  onclick="app.loadTemplate('primeira_consulta')"
                >
                  <i class="fas fa-user-md" aria-hidden="true"></i>
                  1ª Consulta Nefro
                </button>
                <button
                  class="btn secondary sm"
                  onclick="app.loadTemplate('evolucao_hd')"
                >
                  <i class="fas fa-tint" aria-hidden="true"></i>
                  Hemodiálise
                </button>
                <button
                  class="btn secondary sm"
                  onclick="app.loadTemplate('soap')"
                >
                  <i class="fas fa-clipboard-list" aria-hidden="true"></i>
                  SOAP
                </button>
                <button
                  class="btn secondary sm"
                  onclick="app.loadTemplate('custom')"
                >
                  <i class="fas fa-edit" aria-hidden="true"></i>
                  Personalizado
                </button>
              </div>

              <div class="form-group">
                <label class="form-label" for="recordContent"
                  >Evolução Médica</label
                >
                <div class="editor-container">
                  <div class="editor-toolbar">
                    <button
                      type="button"
                      class="btn secondary sm"
                      onclick="app.insertTemplate('vitals')"
                      title="Inserir Sinais Vitais"
                    >
                      <i class="fas fa-heartbeat" aria-hidden="true"></i>
                    </button>
                    <button
                      type="button"
                      class="btn secondary sm"
                      onclick="app.insertTemplate('exam')"
                      title="Inserir Exame Físico"
                    >
                      <i class="fas fa-user-check" aria-hidden="true"></i>
                    </button>
                    <button
                      type="button"
                      class="btn secondary sm"
                      onclick="app.insertTemplate('assessment')"
                      title="Inserir Avaliação"
                    >
                      <i class="fas fa-clipboard-check" aria-hidden="true"></i>
                    </button>
                    <button
                      type="button"
                      class="btn secondary sm"
                      onclick="app.insertTemplate('plan')"
                      title="Inserir Plano"
                    >
                      <i class="fas fa-tasks" aria-hidden="true"></i>
                    </button>
                  </div>
                  <textarea
                    class="medical-editor"
                    id="recordContent"
                    placeholder="Digite a evolução médica aqui..."
                    aria-label="Editor de evolução médica"
                  ></textarea>
                </div>
              </div>

              <div
                style="
                  display: flex;
                  gap: 1rem;
                  justify-content: flex-end;
                  flex-wrap: wrap;
                "
              >
                <button
                  type="button"
                  class="btn secondary"
                  onclick="app.clearRecord()"
                >
                  <i class="fas fa-eraser" aria-hidden="true"></i>
                  Limpar
                </button>
                <button
                  type="button"
                  class="btn secondary"
                  onclick="app.saveAsDraft()"
                >
                  <i class="fas fa-save" aria-hidden="true"></i>
                  Salvar Rascunho
                </button>
                <button
                  type="button"
                  class="btn success"
                  onclick="app.saveRecord(event)"
                >
                  <i class="fas fa-check" aria-hidden="true"></i>
                  Finalizar Evolução
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- Prescriptions Section -->
        <section id="prescriptions" class="section">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">
                <i class="fas fa-prescription-bottle" aria-hidden="true"></i>
                Sistema de Prescrições Digitais
              </h2>
            </div>
            <div class="card-body">
              <div id="birdIdStatusAlert" class="alert warning">
                <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                <div>
                  <strong>Certificado Digital não configurado</strong><br />
                  Configure o Bird ID para habilitar prescrições digitais com
                  validade jurídica nacional.
                </div>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label" for="prescriptionPatientId"
                    >ID do Paciente</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="prescriptionPatientId"
                    placeholder="Digite o ID do paciente"
                  />
                </div>
                <div class="form-group">
                  <label class="form-label" for="prescriptionType"
                    >Tipo de Receita</label
                  >
                  <select class="form-control" id="prescriptionType">
                    <option value="normal">Receita Normal</option>
                    <option value="controlada">Receita Controlada</option>
                    <option value="especial">Receita Especial</option>
                    <option value="antimicrobiano">Antimicrobiano</option>
                  </select>
                </div>
              </div>

              <button
                class="btn primary lg"
                onclick="app.openMemed(event)"
                style="width: 100%; margin: 2rem 0"
              >
                <i class="fas fa-external-link-alt" aria-hidden="true"></i>
                Abrir Memed para Prescrição Digital
              </button>

              <div
                style="
                  background: var(--gray-50);
                  padding: 2rem;
                  border-radius: var(--radius-xl);
                  border: 2px solid var(--gray-200);
                "
              >
                <h3
                  style="
                    margin-bottom: 1.5rem;
                    color: var(--gray-800);
                    font-weight: 700;
                  "
                >
                  <i class="fas fa-star" aria-hidden="true"></i>
                  Recursos Avançados do Sistema
                </h3>
                <div
                  style="
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 1rem;
                  "
                >
                  <div style="display: flex; align-items: center; gap: 0.75rem">
                    <i
                      class="fas fa-check-circle"
                      style="color: var(--success-500); font-size: 1.125rem"
                      aria-hidden="true"
                    ></i>
                    <span style="font-weight: 500"
                      >Integração Nativa com Memed</span
                    >
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.75rem">
                    <i
                      class="fas fa-shield-alt"
                      style="color: var(--success-500); font-size: 1.125rem"
                      aria-hidden="true"
                    ></i>
                    <span style="font-weight: 500"
                      >Assinatura Digital ICP-Brasil</span
                    >
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.75rem">
                    <i
                      class="fas fa-balance-scale"
                      style="color: var(--success-500); font-size: 1.125rem"
                      aria-hidden="true"
                    ></i>
                    <span style="font-weight: 500"
                      >Validade Jurídica Nacional</span
                    >
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.75rem">
                    <i
                      class="fas fa-user-md"
                      style="color: var(--success-500); font-size: 1.125rem"
                      aria-hidden="true"
                    ></i>
                    <span style="font-weight: 500">Compliance 100% CFM</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.75rem">
                    <i
                      class="fas fa-history"
                      style="color: var(--success-500); font-size: 1.125rem"
                      aria-hidden="true"
                    ></i>
                    <span style="font-weight: 500"
                      >Histórico Completo de Prescrições</span
                    >
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.75rem">
                    <i
                      class="fas fa-chart-line"
                      style="color: var(--success-500); font-size: 1.125rem"
                      aria-hidden="true"
                    ></i>
                    <span style="font-weight: 500">Analytics e Relatórios</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="section">
          <div class="dashboard-grid">
            <!-- Bird ID Configuration -->
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">
                  <i class="fas fa-certificate" aria-hidden="true"></i>
                  Certificado Digital Bird ID
                </h2>
              </div>
              <div class="card-body">
                <div id="birdIdCurrentStatus" class="alert info">
                  <i class="fas fa-info-circle" aria-hidden="true"></i>
                  <div>
                    <strong>Verificando status do certificado...</strong><br />
                    Aguarde enquanto validamos a configuração atual.
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label" for="birdIdToken"
                    >Token Bird ID (6 dígitos numéricos)</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="birdIdToken"
                    placeholder="000000"
                    maxlength="6"
                    pattern="[0-9]{6}"
                    aria-describedby="birdIdTokenHelp"
                  />
                  <div
                    id="birdIdTokenHelp"
                    class="form-error"
                    style="display: none"
                  ></div>
                </div>

                <button
                  class="btn warning lg"
                  onclick="app.configureBirdId(event)"
                  style="width: 100%; margin-bottom: 1.5rem"
                >
                  <i class="fas fa-key" aria-hidden="true"></i>
                  Configurar Certificado Digital
                </button>

                <div
                  style="
                    font-size: 0.875rem;
                    color: var(--gray-600);
                    line-height: 1.6;
                  "
                >
                  <p><strong>Sobre o Bird ID:</strong></p>
                  <ul style="margin-left: 1.5rem; margin-top: 0.5rem">
                    <li>
                      Certificado digital ICP-Brasil para assinatura de receitas
                    </li>
                    <li>Validade jurídica em todo território nacional</li>
                    <li>Integração segura com plataformas de prescrição</li>
                    <li>Renovação automática a cada 12 horas</li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- System Information -->
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">
                  <i class="fas fa-info-circle" aria-hidden="true"></i>
                  Informações do Sistema
                </h2>
              </div>
              <div class="card-body">
                <div style="display: grid; gap: 1rem">
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      padding: 0.875rem;
                      background: var(--gray-50);
                      border-radius: var(--radius);
                      border: 1px solid var(--gray-200);
                    "
                  >
                    <span style="font-weight: 600; color: var(--gray-700)"
                      >Versão do Sistema:</span
                    >
                    <span style="font-weight: 500; color: var(--gray-900)"
                      >4.0.0 Professional</span
                    >
                  </div>
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      padding: 0.875rem;
                      background: var(--gray-50);
                      border-radius: var(--radius);
                      border: 1px solid var(--gray-200);
                    "
                  >
                    <span style="font-weight: 600; color: var(--gray-700)"
                      >Médico Responsável:</span
                    >
                    <span style="font-weight: 500; color: var(--gray-900)"
                      >Dr. Matheus Jorge Assali</span
                    >
                  </div>
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      padding: 0.875rem;
                      background: var(--gray-50);
                      border-radius: var(--radius);
                      border: 1px solid var(--gray-200);
                    "
                  >
                    <span style="font-weight: 600; color: var(--gray-700)"
                      >Especialidade:</span
                    >
                    <span style="font-weight: 500; color: var(--gray-900)"
                      >Nefrologia</span
                    >
                  </div>
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      padding: 0.875rem;
                      background: var(--gray-50);
                      border-radius: var(--radius);
                      border: 1px solid var(--gray-200);
                    "
                  >
                    <span style="font-weight: 600; color: var(--gray-700)"
                      >Última Atualização:</span
                    >
                    <span
                      style="font-weight: 500; color: var(--gray-900)"
                      id="lastSystemUpdate"
                      >-</span
                    >
                  </div>
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      padding: 0.875rem;
                      background: var(--gray-50);
                      border-radius: var(--radius);
                      border: 1px solid var(--gray-200);
                    "
                  >
                    <span style="font-weight: 600; color: var(--gray-700)"
                      >Status de Conectividade:</span
                    >
                    <span
                      style="font-weight: 500; color: var(--success-700)"
                      id="connectivityStatus"
                    >
                      <i class="fas fa-check-circle" aria-hidden="true"></i>
                      Online
                    </span>
                  </div>
                </div>

                <div style="margin-top: 2rem">
                  <button
                    class="btn secondary"
                    onclick="app.runSystemDiagnostics()"
                    style="width: 100%"
                  >
                    <i class="fas fa-stethoscope" aria-hidden="true"></i>
                    Executar Diagnósticos do Sistema
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Advanced Features -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">
                <i class="fas fa-cogs" aria-hidden="true"></i>
                Recursos Avançados
              </h2>
            </div>
            <div class="card-body">
              <div
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                  gap: 1.5rem;
                "
              >
                <!-- AI Assistant -->
                <div
                  style="
                    text-align: center;
                    padding: 1.5rem;
                    background: var(--primary-50);
                    border-radius: var(--radius-lg);
                    border: 2px solid var(--primary-200);
                  "
                >
                  <i
                    class="fas fa-robot"
                    style="
                      font-size: 2rem;
                      color: var(--primary-600);
                      margin-bottom: 1rem;
                    "
                    aria-hidden="true"
                  ></i>
                  <h3 style="margin-bottom: 0.5rem; color: var(--primary-800)">
                    IA Assistente
                  </h3>
                  <p
                    style="
                      font-size: 0.875rem;
                      color: var(--primary-700);
                      margin-bottom: 1rem;
                    "
                  >
                    Sugestões inteligentes para diagnósticos e tratamentos
                  </p>
                  <button
                    class="btn primary sm"
                    id="aiToggleBtn"
                    onclick="app.toggleAIAssistant()"
                  >
                    <i class="fas fa-brain" aria-hidden="true"></i>
                    Ativar IA
                  </button>
                </div>

                <!-- Analytics -->
                <div
                  style="
                    text-align: center;
                    padding: 1.5rem;
                    background: var(--success-50);
                    border-radius: var(--radius-lg);
                    border: 2px solid var(--success-200);
                  "
                >
                  <i
                    class="fas fa-chart-bar"
                    style="
                      font-size: 2rem;
                      color: var(--success-600);
                      margin-bottom: 1rem;
                    "
                    aria-hidden="true"
                  ></i>
                  <h3 style="margin-bottom: 0.5rem; color: var(--success-800)">
                    Analytics
                  </h3>
                  <p
                    style="
                      font-size: 0.875rem;
                      color: var(--success-700);
                      margin-bottom: 1rem;
                    "
                  >
                    Relatórios detalhados e métricas de performance
                  </p>
                  <button class="btn success sm" onclick="app.openAnalytics()">
                    <i class="fas fa-chart-line" aria-hidden="true"></i>
                    Ver Relatórios
                  </button>
                </div>

                <!-- Backup -->
                <div
                  style="
                    text-align: center;
                    padding: 1.5rem;
                    background: var(--warning-50);
                    border-radius: var(--radius-lg);
                    border: 2px solid var(--warning-200);
                  "
                >
                  <i
                    class="fas fa-sync-alt"
                    style="
                      font-size: 2rem;
                      color: var(--warning-600);
                      margin-bottom: 1rem;
                    "
                    aria-hidden="true"
                  ></i>
                  <h3 style="margin-bottom: 0.5rem; color: var(--warning-800)">
                    Backup
                  </h3>
                  <p
                    style="
                      font-size: 0.875rem;
                      color: var(--warning-700);
                      margin-bottom: 1rem;
                    "
                  >
                    Backup automático e sincronização em nuvem
                  </p>
                  <button
                    class="btn warning sm"
                    onclick="app.configureBackup()"
                  >
                    <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
                    Configurar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Patient Modal -->
    <div
      class="modal-overlay"
      id="patientModal"
      role="dialog"
      aria-labelledby="patientModalTitle"
      aria-hidden="true"
    >
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title" id="patientModalTitle">Novo Paciente</h3>
        </div>
        <div class="modal-body">
          <form id="patientForm" novalidate>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label" for="patientName"
                  >Nome Completo *</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="patientName"
                  required
                  aria-describedby="patientNameError"
                />
                <div
                  id="patientNameError"
                  class="form-error"
                  style="display: none"
                ></div>
              </div>
              <div class="form-group">
                <label class="form-label" for="patientCPF">CPF</label>
                <input
                  type="text"
                  class="form-control"
                  id="patientCPF"
                  placeholder="000.000.000-00"
                  aria-describedby="patientCPFError"
                />
                <div
                  id="patientCPFError"
                  class="form-error"
                  style="display: none"
                ></div>
              </div>
              <div class="form-group">
                <label class="form-label" for="patientBirth"
                  >Data de Nascimento</label
                >
                <input type="date" class="form-control" id="patientBirth" />
              </div>
              <div class="form-group">
                <label class="form-label" for="patientGender">Sexo</label>
                <select class="form-control" id="patientGender">
                  <option value="">Selecione</option>
                  <option value="M">Masculino</option>
                  <option value="F">Feminino</option>
                  <option value="O">Outro</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" for="patientPhone">Telefone</label>
                <input
                  type="tel"
                  class="form-control"
                  id="patientPhone"
                  placeholder="(15) 99999-9999"
                  aria-describedby="patientPhoneError"
                />
                <div
                  id="patientPhoneError"
                  class="form-error"
                  style="display: none"
                ></div>
              </div>
              <div class="form-group">
                <label class="form-label" for="patientEmail">E-mail</label>
                <input
                  type="email"
                  class="form-control"
                  id="patientEmail"
                  aria-describedby="patientEmailError"
                />
                <div
                  id="patientEmailError"
                  class="form-error"
                  style="display: none"
                ></div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="patientAddress"
                >Endereço Completo</label
              >
              <input
                type="text"
                class="form-control"
                id="patientAddress"
                placeholder="Rua, número, bairro, cidade, estado, CEP"
              />
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label" for="patientInsurance"
                  >Convênio</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="patientInsurance"
                  placeholder="Nome do convênio médico"
                />
              </div>
              <div class="form-group">
                <label class="form-label" for="patientWeight">Peso (kg)</label>
                <input
                  type="number"
                  class="form-control"
                  id="patientWeight"
                  placeholder="70.5"
                  step="0.1"
                  min="0"
                  max="300"
                />
              </div>
              <div class="form-group">
                <label class="form-label" for="patientHeight"
                  >Altura (cm)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="patientHeight"
                  placeholder="170"
                  min="50"
                  max="250"
                />
              </div>
              <div class="form-group">
                <label class="form-label" for="patientBloodType"
                  >Tipo Sanguíneo</label
                >
                <select class="form-control" id="patientBloodType">
                  <option value="">Selecione</option>
                  <option value="A+">A+</option>
                  <option value="A-">A-</option>
                  <option value="B+">B+</option>
                  <option value="B-">B-</option>
                  <option value="AB+">AB+</option>
                  <option value="AB-">AB-</option>
                  <option value="O+">O+</option>
                  <option value="O-">O-</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="patientAllergies"
                >Alergias e Comorbidades</label
              >
              <textarea
                class="form-control"
                id="patientAllergies"
                rows="3"
                placeholder="Descreva alergias medicamentosas, alimentares e principais comorbidades..."
              ></textarea>
            </div>

            <div class="form-group">
              <label class="form-label" for="patientNotes"
                >Observações Gerais</label
              >
              <textarea
                class="form-control"
                id="patientNotes"
                rows="3"
                placeholder="Informações adicionais relevantes sobre o paciente..."
              ></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn secondary"
            onclick="app.closePatientModal()"
          >
            <i class="fas fa-times" aria-hidden="true"></i>
            Cancelar
          </button>
          <button type="button" class="btn success" onclick="app.savePatient()">
            <i class="fas fa-save" aria-hidden="true"></i>
            Salvar Paciente
          </button>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div
      class="modal-overlay"
      id="confirmModal"
      role="dialog"
      aria-labelledby="confirmTitle"
      aria-hidden="true"
    >
      <div class="modal" style="max-width: 500px">
        <div class="modal-body" style="text-align: center; padding: 2rem">
          <div
            style="
              width: 64px;
              height: 64px;
              background: var(--error-50);
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              margin: 0 auto 1.5rem;
            "
          >
            <i
              class="fas fa-exclamation-triangle"
              style="font-size: 1.5rem; color: var(--error-500)"
              aria-hidden="true"
            ></i>
          </div>
          <h3
            id="confirmTitle"
            style="margin-bottom: 0.5rem; color: var(--gray-900)"
          >
            Confirmar Ação
          </h3>
          <p
            id="confirmMessage"
            style="
              color: var(--gray-600);
              margin-bottom: 2rem;
              line-height: 1.6;
            "
          >
            Tem certeza que deseja continuar?
          </p>
          <div style="display: flex; gap: 1rem; justify-content: center">
            <button
              type="button"
              class="btn secondary"
              onclick="app.closeConfirmModal()"
            >
              <i class="fas fa-times" aria-hidden="true"></i>
              Cancelar
            </button>
            <button
              type="button"
              class="btn danger"
              id="confirmButton"
              onclick="app.confirmAction()"
            >
              <i class="fas fa-check" aria-hidden="true"></i>
              Confirmar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Analytics Modal -->
    <div
      class="modal-overlay"
      id="analyticsModal"
      role="dialog"
      aria-labelledby="analyticsModalTitle"
      aria-hidden="true"
    >
      <div class="modal" style="max-width: 1200px">
        <div class="modal-header">
          <h3 class="modal-title" id="analyticsModalTitle">
            Dashboard Analytics
          </h3>
        </div>
        <div class="modal-body">
          <div class="dashboard-grid">
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-data">
                  <div class="metric-value" id="analyticsConsultas">156</div>
                  <div class="metric-label">Consultas este mês</div>
                  <div class="metric-change positive">+12% vs mês anterior</div>
                </div>
                <div class="metric-icon success">
                  <i class="fas fa-chart-line" aria-hidden="true"></i>
                </div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-data">
                  <div class="metric-value" id="analyticsReceitas">89</div>
                  <div class="metric-label">Receitas digitais</div>
                  <div class="metric-change positive">+24% vs mês anterior</div>
                </div>
                <div class="metric-icon warning">
                  <i class="fas fa-prescription" aria-hidden="true"></i>
                </div>
              </div>
            </div>
          </div>
          <div style="margin-top: 2rem">
            <h4>Dados de Performance</h4>
            <div
              id="analyticsData"
              style="
                background: var(--gray-50);
                padding: 1rem;
                border-radius: var(--radius);
                margin-top: 1rem;
                font-family: monospace;
                max-height: 300px;
                overflow-y: auto;
              "
            ></div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn secondary"
            onclick="app.closeAnalyticsModal()"
          >
            Fechar
          </button>
          <button
            type="button"
            class="btn primary"
            onclick="app.exportAnalytics()"
          >
            <i class="fas fa-download" aria-hidden="true"></i>
            Exportar Dados
          </button>
        </div>
      </div>
    </div>

    <!-- JavaScript Application -->
    <script>
      "use strict";

      /**
       * Advanced Medical System Class
       * Complete medical record management system
       */
      class AdvancedMedicalSystem {
        constructor() {
          // Core Properties
          this.currentPatient = null;
          this.patients = [];
          this.dashboardMetrics = {};
          this.birdIdStatus = {};

          // UI State
          this.searchTimeout = null;
          this.isLoading = false;
          this.confirmCallback = null;

          // Features
          this.templates = new Map();
          this.autoSaveInterval = null;
          this.performanceMetrics = new Map();
          this.aiAssistantActive = false;

          // Backup Configuration
          this.backupConfig = {
            enabled: false,
            interval: "24h",
            location: "cloud",
          };

          // Initialize System
          this.init();
        }

        /**
         * Initialize the medical system
         */
        async init() {
          const startTime = performance.now();

          try {
            // Setup core functionality
            this.setupNavigation();
            this.setupEventListeners();
            this.setupKeyboardShortcuts();
            this.setupAutoSave();
            this.loadTemplates();

            // Load initial data with mock functionality
            await Promise.all([
              this.loadDashboardData(),
              this.loadPatients(),
              this.checkBirdIdStatus(),
            ]);

            // Setup additional features
            this.setDefaultDateTime();
            this.setupPerformanceMonitoring();
            this.loadAIAssistantState();
            this.loadBackupConfig();

            // Track performance
            const initTime = performance.now() - startTime;
            this.recordPerformance("init", initTime);

            // Show success message
            this.showToast("Sistema carregado com sucesso!", "success");
          } catch (error) {
            this.showToast(`Erro ao inicializar: ${error.message}`, "error");
          }
        }

        /**
         * Setup navigation between sections
         */
        setupNavigation() {
          const navTabs = document.querySelectorAll(".nav-tab");
          const sections = document.querySelectorAll(".section");

          navTabs.forEach((tab) => {
            tab.addEventListener("click", () => {
              const targetSection = tab.dataset.section;

              // Update active states
              navTabs.forEach((t) => t.classList.remove("active"));
              sections.forEach((s) => s.classList.remove("active"));

              tab.classList.add("active");
              const section = document.getElementById(targetSection);
              if (section) {
                section.classList.add("active");
                this.trackEvent("navigation", {
                  section: targetSection,
                  timestamp: new Date().toISOString(),
                });
              }
            });
          });
        }

        /**
         * Setup event listeners for forms and UI elements
         */
        setupEventListeners() {
          // Patient search functionality
          const searchInput = document.getElementById("patientSearch");
          if (searchInput) {
            searchInput.addEventListener("input", (e) => {
              clearTimeout(this.searchTimeout);
              this.searchTimeout = setTimeout(() => {
                this.searchPatients(e.target.value);
              }, 300);
            });
          }

          // Patient form handling
          const patientForm = document.getElementById("patientForm");
          if (patientForm) {
            patientForm.addEventListener("submit", (e) => {
              e.preventDefault();
              this.savePatient();
            });

            // Real-time validation
            const inputs = patientForm.querySelectorAll(
              "input, select, textarea",
            );
            inputs.forEach((input) => {
              input.addEventListener("blur", () => this.validateField(input));
              input.addEventListener("input", () =>
                this.clearFieldError(input),
              );
            });
          }

          // Modal click outside handling
          const modals = document.querySelectorAll(".modal-overlay");
          modals.forEach((modal) => {
            modal.addEventListener("click", (e) => {
              if (e.target === modal) {
                this.closeModal(modal);
              }
            });
          });

          // Save metrics on page unload
          window.addEventListener("beforeunload", () => {
            this.saveMetrics();
          });
        }

        /**
         * Setup keyboard shortcuts for power users
         */
        setupKeyboardShortcuts() {
          document.addEventListener("keydown", (e) => {
            // Ctrl/Cmd shortcuts
            if (e.ctrlKey || e.metaKey) {
              switch (e.key) {
                case "k":
                  e.preventDefault();
                  this.focusSearch();
                  break;
                case "n":
                  if (e.shiftKey) {
                    e.preventDefault();
                    this.showAddPatientModal();
                  }
                  break;
                case "f":
                  e.preventDefault();
                  this.openQuickSearch();
                  break;
                case "s":
                  e.preventDefault();
                  this.quickSave();
                  break;
              }
            }

            // Alt shortcuts for navigation
            if (e.altKey) {
              const sectionMap = {
                1: "dashboard",
                2: "patients",
                3: "records",
                4: "prescriptions",
                5: "settings",
              };

              const section = sectionMap[e.key];
              if (section) {
                e.preventDefault();
                this.navigateToSection(section);
              }
            }

            // Escape to close modals
            if (e.key === "Escape") {
              this.closeAllModals();
            }
          });
        }

        /**
         * Setup auto-save functionality for medical records
         */
        setupAutoSave() {
          const editor = document.getElementById("recordContent");
          if (editor) {
            let autoSaveTimeout;
            editor.addEventListener("input", () => {
              clearTimeout(autoSaveTimeout);
              autoSaveTimeout = setTimeout(() => {
                this.autoSaveRecord();
              }, 2000);
            });
            this.loadAutoSavedContent();
          }
        }

        /**
         * Load medical record templates
         */
        loadTemplates() {
          this.templates.set(
            "vitals",
            `
SINAIS VITAIS:
PA: ___x___mmHg | FC: ___bpm | FR: ___irpm | T: ___°C
Peso: ___kg | Altura: ___cm | IMC: ___kg/m² | SatO2: ___%
                `,
          );

          this.templates.set(
            "exam",
            `
EXAME FÍSICO:
Estado geral: □ BEG □ REG □ MEG
Consciência: □ Lúcido □ Confuso □ Sonolento
Hidratação: □ Hidratado □ Desidratado
Coloração: □ Corado □ Pálido □ Ictérico
Edema: □ Ausente □ Presente (__/4+)
                `,
          );

          this.templates.set(
            "assessment",
            `
AVALIAÇÃO:
Hipóteses diagnósticas:
1. _____________________________ (CID-10: _____)
2. _____________________________ (CID-10: _____)

Problemas ativos:
- ________________________________
- ________________________________
                `,
          );

          this.templates.set(
            "plan",
            `
PLANO TERAPÊUTICO:
Medicações:
- ________________________________
- ________________________________

Exames solicitados:
- ________________________________
- ________________________________

Orientações:
- ________________________________
- ________________________________

Retorno: ________
                `,
          );
        }

        /**
         * Load dashboard data and metrics (Mock Implementation)
         */
        async loadDashboardData() {
          try {
            const startTime = performance.now();

            // Simulate API call with realistic data
            await new Promise((resolve) => setTimeout(resolve, 500));

            this.dashboardMetrics = {
              totalPatients: Math.floor(Math.random() * 500) + 100,
              todayConsultations: Math.floor(Math.random() * 20) + 5,
              activePrescriptions: Math.floor(Math.random() * 50) + 10,
              newPatientsThisMonth: Math.floor(Math.random() * 30) + 5,
            };

            this.updateDashboardUI();

            const loadTime = performance.now() - startTime;
            this.recordPerformance("dashboard_load", loadTime);
          } catch (error) {
            this.handleError(error, "Dashboard");
          }
        }

        /**
         * Update dashboard UI with animated metrics
         */
        updateDashboardUI() {
          this.animateMetric(
            "totalPatients",
            this.dashboardMetrics.totalPatients || 0,
          );
          this.animateMetric(
            "todayConsultations",
            this.dashboardMetrics.todayConsultations || 0,
          );
          this.animateMetric(
            "activePrescriptions",
            this.dashboardMetrics.activePrescriptions || 0,
          );

          // Update change indicators
          const pc = document.getElementById("patientsChange");
          if (pc)
            pc.textContent = `+${this.dashboardMetrics.newPatientsThisMonth || 0} este mês`;

          const cc = document.getElementById("consultationsChange");
          if (cc)
            cc.textContent = `Atualizado há ${this.getRelativeTime(new Date())}`;

          const lu = document.getElementById("lastSystemUpdate");
          if (lu) lu.textContent = new Date().toLocaleString("pt-BR");

          this.updateBirdIdDashboard();
        }

        /**
         * Animate metric counters with smooth easing
         */
        animateMetric(elementId, targetValue) {
          const element = document.getElementById(elementId);
          if (!element) return;

          const startValue = parseInt(element.textContent, 10) || 0;
          const duration = 1000;
          const startTime = performance.now();

          const animate = (currentTime) => {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easeOutQuart = 1 - Math.pow(1 - progress, 4);
            const current = Math.floor(
              startValue + (targetValue - startValue) * easeOutQuart,
            );

            element.textContent = current.toLocaleString("pt-BR");

            if (progress < 1) {
              requestAnimationFrame(animate);
            }
          };

          requestAnimationFrame(animate);
        }

        /**
         * Load patients with search and filtering (Mock Implementation)
         */
        async loadPatients(query = "", filters = {}) {
          try {
            this.setLoadingState(true);
            const startTime = performance.now();

            // Mock patient data
            const mockPatients = [
              {
                id: "PAT001",
                nome: "Maria Silva Santos",
                idade: 45,
                telefone: "(15) 99876-5432",
                sexo: "F",
                convenio: "Unimed",
                status: "active",
              },
              {
                id: "PAT002",
                nome: "João Pedro Oliveira",
                idade: 67,
                telefone: "(15) 98765-4321",
                sexo: "M",
                convenio: "Bradesco Saúde",
                status: "active",
              },
              {
                id: "PAT003",
                nome: "Ana Carolina Ferreira",
                idade: 34,
                telefone: "(15) 97654-3210",
                sexo: "F",
                convenio: "SUS",
                status: "active",
              },
              {
                id: "PAT004",
                nome: "Carlos Eduardo Lima",
                idade: 56,
                telefone: "(15) 96543-2109",
                sexo: "M",
                convenio: "Amil",
                status: "active",
              },
              {
                id: "PAT005",
                nome: "Beatriz Souza Costa",
                idade: 29,
                telefone: "(15) 95432-1098",
                sexo: "F",
                convenio: "NotreDame",
                status: "active",
              },
            ];

            // Simulate API delay
            await new Promise((resolve) => setTimeout(resolve, 800));

            // Filter patients based on query
            const filteredPatients = mockPatients.filter(
              (p) =>
                !query ||
                p.nome.toLowerCase().includes(query.toLowerCase()) ||
                p.id.toLowerCase().includes(query.toLowerCase()) ||
                p.telefone.includes(query) ||
                (p.convenio &&
                  p.convenio.toLowerCase().includes(query.toLowerCase())),
            );

            this.patients = filteredPatients;
            this.renderPatients();
            this.updateSearchResults(filteredPatients.length, query);

            const loadTime = performance.now() - startTime;
            this.recordPerformance("patients_load", loadTime);
          } catch (error) {
            this.showPatientsError("Erro de conexão");
          } finally {
            this.setLoadingState(false);
          }
        }

        /**
         * Set loading state for patients section
         */
        setLoadingState(loading) {
          this.isLoading = loading;
          const container = document.getElementById("patientsContainer");

          if (loading) {
            container.innerHTML = `
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            <p>Carregando pacientes...</p>
                        </div>
                    `;
          }
        }

        /**
         * Render patients list with cards
         */
        renderPatients() {
          const container = document.getElementById("patientsContainer");

          if (this.patients.length === 0) {
            container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>Nenhum paciente encontrado</h3>
                            <p>Adicione seu primeiro paciente ou refine sua busca.</p>
                            <button class="btn primary" onclick="app.showAddPatientModal()">
                                <i class="fas fa-plus"></i>
                                Adicionar Primeiro Paciente
                            </button>
                        </div>
                    `;
            return;
          }

          const html = this.patients
            .map((patient) => {
              const nomeEsc = this.escapeHtml(patient.nome);
              const nomeJs = this.escapeJsString(patient.nome);

              return `
                        <div class="patient-card" onclick="app.selectPatient('${patient.id}')" data-patient-id="${patient.id}">
                            <div class="patient-header">
                                <div class="patient-avatar" style="background:${this.getPatientColor(patient.nome)}">
                                    ${this.safeInitial(patient.nome)}
                                </div>
                                <div class="patient-info">
                                    <div class="patient-name">${nomeEsc}</div>
                                    <div class="patient-meta">
                                        <span><i class="fas fa-birthday-cake"></i> ${patient.idade} anos</span>
                                        <span><i class="fas fa-phone"></i> ${patient.telefone}</span>
                                        <span><i class="fas fa-venus-mars"></i> ${patient.sexo || "N/I"}</span>
                                        <span><i class="fas fa-id-card"></i> ${patient.id}</span>
                                        ${patient.convenio ? `<span><i class="fas fa-hospital"></i> ${this.escapeHtml(patient.convenio)}</span>` : ""}
                                    </div>
                                </div>
                                <div class="patient-status ${String(patient.status || "").toLowerCase()}">
                                    <i class="fas fa-circle"></i>
                                    ${patient.status}
                                </div>
                            </div>
                            <div class="patient-actions" onclick="app.stopPropagation(event)">
                                <button class="btn primary sm" onclick="app.prescribeToPatient('${patient.id}','${nomeJs}',event)" title="Prescrever medicamento">
                                    <i class="fas fa-prescription-bottle"></i>
                                </button>
                                <button class="btn secondary sm" onclick="app.createEvolution('${patient.id}')" title="Nova evolução">
                                    <i class="fas fa-file-medical"></i>
                                </button>
                                <button class="btn secondary sm" onclick="app.editPatient('${patient.id}')" title="Editar paciente">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn danger sm" onclick="app.deletePatient('${patient.id}','${nomeJs}',event)" title="Excluir paciente">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
            })
            .join("");

          container.innerHTML = `<div class="patient-grid">${html}</div>`;
        }

        /**
         * Update search results counter
         */
        updateSearchResults(total, query) {
          const counter = document.getElementById("searchResultsCount");
          if (counter) {
            counter.textContent = query.trim()
              ? `${total} resultado(s) encontrado(s) para "${query}"`
              : `${total} paciente(s) cadastrado(s)`;
          }
        }

        /**
         * Show error state for patients
         */
        showPatientsError(message) {
          const container = document.getElementById("patientsContainer");
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Erro ao carregar pacientes</h3>
                        <p>${this.escapeHtml(message)}</p>
                        <button class="btn primary" onclick="app.loadPatients()">
                            <i class="fas fa-redo"></i>
                            Tentar Novamente
                        </button>
                    </div>
                `;
        }

        /**
         * Search patients with debouncing
         */
        async searchPatients(query) {
          this.trackEvent("search", {
            query,
            timestamp: new Date().toISOString(),
          });
          await this.loadPatients(query);
        }

        /**
         * Select a patient and update UI
         */
        selectPatient(patientId) {
          // Update visual selection
          document
            .querySelectorAll(".patient-card")
            .forEach((c) => c.classList.remove("selected"));
          const card = document.querySelector(
            `[data-patient-id="${patientId}"]`,
          );
          if (card) card.classList.add("selected");

          // Update current patient
          const patient = this.patients.find((p) => p.id === patientId);
          if (patient) {
            this.currentPatient = patient;

            // Auto-fill patient ID in forms
            const rpid = document.getElementById("recordPatientId");
            const ppid = document.getElementById("prescriptionPatientId");
            if (rpid) rpid.value = patientId;
            if (ppid) ppid.value = patientId;

            this.showToast(`Paciente selecionado: ${patient.nome}`, "success");
            this.trackEvent("patient_selected", {
              patientId,
              patientName: patient.nome,
            });
          }
        }

        /**
         * Show add patient modal
         */
        showAddPatientModal() {
          this.currentPatient = null;

          const title = document.getElementById("patientModalTitle");
          if (title) title.textContent = "Novo Paciente";

          const form = document.getElementById("patientForm");
          if (form) form.reset();

          this.clearAllFieldErrors();

          const modal = document.getElementById("patientModal");
          modal.classList.add("show");
          modal.setAttribute("aria-hidden", "false");

          // Focus first input
          setTimeout(() => {
            const name = document.getElementById("patientName");
            if (name) name.focus();
          }, 300);

          this.trackEvent("modal_opened", {
            modal: "patient_form",
            mode: "create",
          });
        }

        /**
         * Edit existing patient (Mock Implementation)
         */
        async editPatient(patientId) {
          try {
            // Find patient in mock data
            const patient = this.patients.find((p) => p.id === patientId);
            if (patient) {
              this.currentPatient = patient;

              const title = document.getElementById("patientModalTitle");
              if (title) title.textContent = "Editar Paciente";

              this.fillPatientForm(patient);

              const modal = document.getElementById("patientModal");
              modal.classList.add("show");
              modal.setAttribute("aria-hidden", "false");

              this.trackEvent("modal_opened", {
                modal: "patient_form",
                mode: "edit",
                patientId,
              });
            } else {
              this.showToast("Paciente não encontrado", "error");
            }
          } catch (error) {
            this.handleError(error, "Carregar dados do paciente");
          }
        }

        /**
         * Fill patient form with existing data
         */
        fillPatientForm(p) {
          const map = {
            patientName: p.nome || p.Nome,
            patientCPF: p.CPF,
            patientBirth: p.DataNascimento,
            patientGender: p.sexo || p.Sexo,
            patientPhone: p.telefone || p.Telefone,
            patientEmail: p.Email,
            patientAddress: p.Endereco,
            patientInsurance: p.convenio || p.ConvenioNome || p.Convenio || "",
            patientWeight: p.Peso,
            patientHeight: p.Altura,
            patientBloodType: p.TipoSanguineo,
            patientAllergies: [
              p.AlergiasMedicamentosas,
              p.AlergiasAlimentares,
              p.AlergiasAmbientais,
              p.ComorbidadesPrincipais,
            ]
              .filter(Boolean)
              .join("; "),
            patientNotes: p.Observacoes,
          };

          Object.entries(map).forEach(([id, val]) => {
            const el = document.getElementById(id);
            if (el && val != null) el.value = val;
          });
        }

        /**
         * Validate form field with real-time feedback
         */
        validateField(field) {
          const value = field.value.trim();
          const id = field.id;
          let ok = true;
          let msg = "";

          // Field-specific validation
          switch (id) {
            case "patientName":
              if (!value || value.length < 2) {
                ok = false;
                msg = "Nome deve ter pelo menos 2 caracteres";
              }
              break;

            case "patientCPF":
              if (value && !this.validateCPF(value)) {
                ok = false;
                msg = "CPF inválido";
              }
              break;

            case "patientEmail":
              if (value && !this.validateEmail(value)) {
                ok = false;
                msg = "E-mail inválido";
              }
              break;

            case "patientPhone":
              if (value && value.replace(/\D/g, "").length < 10) {
                ok = false;
                msg = "Telefone deve ter pelo menos 10 dígitos";
              }
              break;

            case "patientWeight":
              if (value && (isNaN(value) || value <= 0 || value > 300)) {
                ok = false;
                msg = "Peso deve estar entre 0 e 300 kg";
              }
              break;

            case "patientHeight":
              if (value && (isNaN(value) || value < 50 || value > 250)) {
                ok = false;
                msg = "Altura deve estar entre 50 e 250 cm";
              }
              break;
          }

          // Update UI based on validation
          if (ok) {
            field.classList.remove("error");
            this.hideFieldError(id);
          } else {
            field.classList.add("error");
            this.showFieldError(id, msg);
          }

          return ok;
        }

        /**
         * Validate entire form
         */
        validateForm() {
          const form = document.getElementById("patientForm");
          const fields = form.querySelectorAll("input, select, textarea");
          let ok = true;

          fields.forEach((f) => {
            if (!this.validateField(f)) ok = false;
          });

          return ok;
        }

        /**
         * Show field validation error
         */
        showFieldError(fieldId, message) {
          const el = document.getElementById(fieldId + "Error");
          if (el) {
            el.textContent = message;
            el.style.display = "block";
          }
        }

        /**
         * Hide field validation error
         */
        hideFieldError(fieldId) {
          const el = document.getElementById(fieldId + "Error");
          if (el) el.style.display = "none";
        }

        /**
         * Clear field error state
         */
        clearFieldError(field) {
          field.classList.remove("error");
          this.hideFieldError(field.id);
        }

        /**
         * Clear all form errors
         */
        clearAllFieldErrors() {
          const form = document.getElementById("patientForm");
          const fields = form.querySelectorAll("input, select, textarea");
          fields.forEach((f) => this.clearFieldError(f));
        }

        /**
         * Save patient data (Mock Implementation)
         */
        async savePatient() {
          if (!this.validateForm()) {
            this.showToast(
              "Por favor, corrija os erros no formulário",
              "error",
            );
            return;
          }

          const saveBtn = document.querySelector("#patientModal .btn.success");
          if (saveBtn) {
            saveBtn.classList.add("loading");
            saveBtn.disabled = true;
          }

          try {
            const formData = {
              ID: this.currentPatient?.ID || "PAT" + Date.now(),
              Nome: document.getElementById("patientName").value.trim(),
              CPF: document.getElementById("patientCPF").value.trim(),
              DataNascimento: document.getElementById("patientBirth").value,
              Sexo: document.getElementById("patientGender").value,
              Telefone: document.getElementById("patientPhone").value.trim(),
              Email: document.getElementById("patientEmail").value.trim(),
              Endereco: document.getElementById("patientAddress").value.trim(),
              Convenio: document
                .getElementById("patientInsurance")
                .value.trim(),
              Peso: document.getElementById("patientWeight").value,
              Altura: document.getElementById("patientHeight").value,
              TipoSanguineo: document.getElementById("patientBloodType").value,
              Alergias: document
                .getElementById("patientAllergies")
                .value.trim(),
              Observacoes: document.getElementById("patientNotes").value.trim(),
            };

            // Simulate save operation
            await new Promise((resolve) => setTimeout(resolve, 1000));

            const isUpdate = !!this.currentPatient;
            this.showToast(
              isUpdate
                ? "Paciente atualizado com sucesso!"
                : "Paciente cadastrado com sucesso!",
              "success",
            );

            this.closePatientModal();
            await this.loadPatients();
            await this.loadDashboardData();

            this.trackEvent("patient_saved", {
              patientId: formData.ID,
              isUpdate,
              patientName: formData.Nome,
            });
          } catch (error) {
            this.handleError(error, "Salvar paciente");
          } finally {
            if (saveBtn) {
              saveBtn.classList.remove("loading");
              saveBtn.disabled = false;
            }
          }
        }

        /**
         * Close patient modal
         */
        closePatientModal() {
          const modal = document.getElementById("patientModal");
          modal.classList.remove("show");
          modal.setAttribute("aria-hidden", "true");
          this.trackEvent("modal_closed", { modal: "patient_form" });
        }

        /**
         * Stop event propagation
         */
        stopPropagation(ev) {
          if (ev && typeof ev.stopPropagation === "function") {
            ev.stopPropagation();
          }
        }

        /**
         * Open prescription for patient (Mock Implementation)
         */
        async prescribeToPatient(patientId, patientName, ev = null) {
          const btn = ev && (ev.currentTarget || ev.target);
          if (btn) {
            btn.classList.add("loading");
            btn.disabled = true;
          }

          try {
            // Simulate Memed integration
            setTimeout(() => {
              const name =
                patientName ||
                this.patients.find((p) => p.id === patientId)?.nome ||
                "Paciente";

              this.showToast(
                `Prescrição simulada aberta para ${name}`,
                "success",
              );
              this.trackEvent("prescription_opened", {
                patientId,
                patientName: name,
                platform: "memed",
              });

              if (btn) {
                btn.classList.remove("loading");
                btn.disabled = false;
              }
            }, 1000);
          } catch (error) {
            this.handleError(error, "Abrir prescrição");
            if (btn) {
              btn.classList.remove("loading");
              btn.disabled = false;
            }
          }
        }

        /**
         * Create new evolution for patient
         */
        createEvolution(patientId) {
          const tab = document.querySelector(
            '.nav-tab[data-section="records"]',
          );
          if (tab) tab.click();

          setTimeout(() => {
            const rpid = document.getElementById("recordPatientId");
            const rc = document.getElementById("recordContent");
            if (rpid) rpid.value = patientId;
            if (rc) rc.focus();
          }, 300);

          this.trackEvent("evolution_started", { patientId });
        }

        /**
         * Delete patient with confirmation
         */
        deletePatient(patientId, patientName, ev = null) {
          if (ev) ev.stopPropagation();

          this.showConfirm(
            "Excluir Paciente",
            `Tem certeza que deseja excluir o paciente <strong>${this.escapeHtml(patientName)}</strong>?<br><br>
                    <div style="color:var(--error-700);font-weight:600;margin-top:1rem">
                        ⚠️ Esta ação não pode ser desfeita e removerá:
                    </div>
                    <ul style="margin-top:.5rem;text-align:left;color:var(--gray-600)">
                        <li>Todos os dados do paciente</li>
                        <li>Histórico de consultas e evoluções</li>
                        <li>Prescrições relacionadas</li>
                        <li>Exames e resultados</li>
                    </ul>`,
            async () => {
              try {
                // Remove patient from list
                const patientIndex = this.patients.findIndex(
                  (p) => p.id === patientId,
                );
                if (patientIndex !== -1) {
                  this.patients.splice(patientIndex, 1);
                  this.renderPatients();
                  this.updateSearchResults(this.patients.length, "");
                  await this.loadDashboardData();

                  this.showToast(
                    `Paciente ${patientName} excluído com sucesso`,
                    "success",
                  );
                  this.trackEvent("patient_deleted", {
                    patientId,
                    patientName,
                  });
                } else {
                  this.showToast("Paciente não encontrado", "error");
                }
              } catch (error) {
                this.handleError(error, "Excluir paciente");
              }
            },
          );
        }

        /**
         * Load medical record template
         */
        loadTemplate(templateType) {
          const editor = document.getElementById("recordContent");
          if (!editor) return;

          let content = this.getLocalTemplate(templateType);

          // Replace template variables
          if (this.currentPatient) {
            content = content.replace(
              /\{\{NOME\}\}/g,
              this.currentPatient.nome || "____",
            );
            content = content.replace(
              /\{\{IDADE\}\}/g,
              this.currentPatient.idade || "____",
            );
            content = content.replace(
              /\{\{SEXO\}\}/g,
              this.currentPatient.sexo || "____",
            );
          }

          content = content.replace(
            /\{\{DATA\}\}/g,
            new Date().toLocaleDateString("pt-BR"),
          );
          content = content.replace(
            /\{\{HORA\}\}/g,
            new Date().toLocaleTimeString("pt-BR", {
              hour: "2-digit",
              minute: "2-digit",
            }),
          );

          editor.value = content;
          editor.focus();

          this.trackEvent("template_loaded", {
            templateType,
            patientId: this.currentPatient?.id,
          });
        }

        /**
         * Insert template at cursor position
         */
        insertTemplate(templateType) {
          const editor = document.getElementById("recordContent");
          if (!editor) return;

          const template = this.templates.get(templateType);
          if (template) {
            const cursor = editor.selectionStart;
            const before = editor.value.substring(0, cursor);
            const after = editor.value.substring(editor.selectionEnd);

            editor.value = before + template + after;
            editor.selectionStart = editor.selectionEnd =
              cursor + template.length;
            editor.focus();

            this.trackEvent("template_inserted", { templateType });
          }
        }

        /**
         * Save medical record (Mock Implementation)
         */
        async saveRecord(ev = null) {
          const saveBtn =
            ev?.currentTarget ||
            ev?.target ||
            document.querySelector("#records .btn.success");

          if (saveBtn) {
            saveBtn.classList.add("loading");
            saveBtn.disabled = true;
          }

          try {
            const data = {
              PacienteID: document
                .getElementById("recordPatientId")
                .value.trim(),
              TipoConsulta: document.getElementById("recordType").value,
              DataConsulta: document.getElementById("recordDate").value,
              EvolucaoTextual: document
                .getElementById("recordContent")
                .value.trim(),
              StatusEvolucao: "Finalizada",
            };

            if (!data.PacienteID || !data.EvolucaoTextual) {
              this.showToast(
                "Preencha o ID do paciente e o conteúdo da evolução",
                "warning",
              );
              return;
            }

            // Simulate save operation
            await new Promise((resolve) => setTimeout(resolve, 1000));

            this.showToast("Evolução médica salva com sucesso!", "success");
            this.clearRecord();

            this.trackEvent("evolution_saved", {
              evolutionId: "EVO" + Date.now(),
              patientId: data.PacienteID,
              type: data.TipoConsulta,
            });

            localStorage.removeItem("medical_record_autosave");
          } catch (error) {
            this.handleError(error, "Salvar evolução");
          } finally {
            if (saveBtn) {
              saveBtn.classList.remove("loading");
              saveBtn.disabled = false;
            }
          }
        }

        /**
         * Save record as draft
         */
        saveAsDraft() {
          const content = document.getElementById("recordContent").value.trim();
          const patientId = document
            .getElementById("recordPatientId")
            .value.trim();

          if (content.length > 10) {
            const draft = {
              content,
              patientId,
              type: document.getElementById("recordType").value,
              timestamp: new Date().toISOString(),
            };

            localStorage.setItem("medical_record_draft", JSON.stringify(draft));
            this.showToast("Rascunho salvo localmente", "success");
            this.trackEvent("draft_saved", { patientId });
          } else {
            this.showToast(
              "Conteúdo muito pequeno para salvar como rascunho",
              "warning",
            );
          }
        }

        /**
         * Clear medical record form
         */
        clearRecord() {
          const rc = document.getElementById("recordContent");
          if (rc) rc.value = "";

          this.setDefaultDateTime();
          localStorage.removeItem("medical_record_autosave");
          localStorage.removeItem("medical_record_draft");
        }

        /**
         * Auto-save record content
         */
        autoSaveRecord() {
          const content = document.getElementById("recordContent").value.trim();
          const patientId = document
            .getElementById("recordPatientId")
            .value.trim();

          if (content.length > 50) {
            const data = {
              content,
              patientId,
              timestamp: new Date().toISOString(),
            };

            localStorage.setItem(
              "medical_record_autosave",
              JSON.stringify(data),
            );
          }
        }

        /**
         * Load auto-saved content on startup
         */
        loadAutoSavedContent() {
          const auto = localStorage.getItem("medical_record_autosave");
          const draft = localStorage.getItem("medical_record_draft");

          if (auto || draft) {
            try {
              const data = JSON.parse(auto || draft);
              const diff =
                new Date().getTime() - new Date(data.timestamp).getTime();

              // Only restore if less than 2 hours old
              if (diff < 2 * 60 * 60 * 1000) {
                const type = auto ? "auto-salvamento" : "rascunho";

                if (
                  confirm(
                    `Encontramos um ${type} de ${this.getRelativeTime(new Date(data.timestamp))}. Deseja restaurá-lo?`,
                  )
                ) {
                  document.getElementById("recordContent").value = data.content;
                  if (data.patientId) {
                    document.getElementById("recordPatientId").value =
                      data.patientId;
                  }

                  this.showToast(
                    `${type.charAt(0).toUpperCase() + type.slice(1)} restaurado`,
                    "success",
                  );
                }
              }
            } catch (e) {
              localStorage.removeItem("medical_record_autosave");
              localStorage.removeItem("medical_record_draft");
            }
          }
        }

        /**
         * Check Bird ID certificate status (Mock Implementation)
         */
        async checkBirdIdStatus() {
          try {
            // Simulate Bird ID status check
            this.birdIdStatus = {
              valid: Math.random() > 0.5,
              timeLeft: Math.floor(Math.random() * 300) + 60,
              configured: true,
              message: "Certificado configurado e válido",
            };

            this.updateBirdIdUI();
          } catch (error) {
            // Silently handle errors for background checks
          }
        }

        /**
         * Update Bird ID UI elements
         */
        updateBirdIdUI() {
          const statusAlert = document.getElementById("birdIdStatusAlert");
          const currentStatus = document.getElementById("birdIdCurrentStatus");

          if (this.birdIdStatus?.valid) {
            statusAlert.className = "alert success";
            statusAlert.innerHTML = `
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>Certificado Digital Ativo</strong><br>
                            Prescrições digitais habilitadas com validade jurídica nacional.
                            Válido por mais ${this.birdIdStatus.timeLeft} minutos.
                        </div>
                    `;

            currentStatus.className = "alert success";
            currentStatus.innerHTML = `
                        <i class="fas fa-certificate"></i>
                        <div>
                            <strong>Certificado Ativo</strong><br>
                            ${this.birdIdStatus.message}
                        </div>
                    `;
          } else {
            const msg = this.birdIdStatus?.configured
              ? "Certificado expirado - Renovação necessária"
              : "Certificado não configurado";

            statusAlert.className = "alert warning";
            statusAlert.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>${msg}</strong><br>
                            Configure o Bird ID para habilitar prescrições digitais.
                        </div>
                    `;

            currentStatus.className = "alert warning";
            currentStatus.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>${msg}</strong><br>
                            ${this.birdIdStatus?.message || "Configure para ativar funcionalidades avançadas."}
                        </div>
                    `;
          }

          this.updateBirdIdDashboard();
        }

        /**
         * Update Bird ID dashboard metric
         */
        updateBirdIdDashboard() {
          const statusElement = document.getElementById("birdIdStatus");
          const iconElement = document.getElementById("birdIdIcon");
          const changeElement = document.getElementById("birdIdChange");

          if (this.birdIdStatus?.valid) {
            statusElement.textContent = "Ativo";
            iconElement.className = "metric-icon success";
            changeElement.textContent = `Expira em ${this.birdIdStatus.timeLeft}min`;
            changeElement.className = "metric-change positive";
          } else {
            statusElement.textContent = "Inativo";
            iconElement.className = "metric-icon warning";
            changeElement.textContent = "Necessita configuração";
            changeElement.className = "metric-change negative";
          }
        }

        /**
         * Configure Bird ID certificate (Mock Implementation)
         */
        async configureBirdId(ev = null) {
          const token = document.getElementById("birdIdToken").value.trim();

          if (!/^\d{6}$/.test(token)) {
            this.showToast(
              "Token deve ter exatamente 6 dígitos numéricos",
              "error",
            );
            this.showFieldError("birdIdToken", "Token inválido");
            return;
          }

          const configBtn =
            ev?.currentTarget ||
            ev?.target ||
            document.querySelector("#settings .btn.warning");

          if (configBtn) {
            configBtn.classList.add("loading");
            configBtn.disabled = true;
          }

          try {
            // Simulate Bird ID configuration
            await new Promise((resolve) => setTimeout(resolve, 2000));

            this.showToast("Certificado configurado com sucesso!", "success");
            document.getElementById("birdIdToken").value = "";

            this.birdIdStatus = {
              valid: true,
              timeLeft: 720,
              configured: true,
              message: "Certificado configurado e ativo",
            };

            this.updateBirdIdUI();
            this.loadDashboardData();

            this.trackEvent("bird_id_configured", {
              success: true,
              validUntil: new Date(Date.now() + 720 * 60 * 1000).toISOString(),
            });
          } catch (error) {
            this.handleError(error, "Configurar certificado");
          } finally {
            if (configBtn) {
              configBtn.classList.remove("loading");
              configBtn.disabled = false;
            }
          }
        }

        /**
         * Open Memed prescription system (Mock Implementation)
         */
        async openMemed(ev = null) {
          const patientId = document
            .getElementById("prescriptionPatientId")
            .value.trim();

          if (!patientId) {
            this.showToast("Digite o ID do paciente primeiro", "warning");
            document.getElementById("prescriptionPatientId").focus();
            return;
          }

          await this.prescribeToPatient(patientId, "Paciente Selecionado", ev);
        }

        /**
         * Refresh dashboard data
         */
        async refreshDashboard(ev = null) {
          const refreshBtn =
            ev?.currentTarget ||
            ev?.target ||
            document.querySelector(".quick-actions .btn.secondary");

          if (refreshBtn) {
            refreshBtn.classList.add("loading");
            refreshBtn.disabled = true;
          }

          try {
            this.showToast("Atualizando dados do sistema...", "info");

            await Promise.all([
              this.loadDashboardData(),
              this.loadPatients(),
              this.checkBirdIdStatus(),
            ]);

            this.showToast("Dados atualizados com sucesso!", "success");
            this.trackEvent("dashboard_refreshed", {
              timestamp: new Date().toISOString(),
            });
          } catch (error) {
            this.handleError(error, "Atualizar dashboard");
          } finally {
            if (refreshBtn) {
              refreshBtn.classList.remove("loading");
              refreshBtn.disabled = false;
            }
          }
        }

        /**
         * Open quick search
         */
        openQuickSearch() {
          const searchInput = document.getElementById("patientSearch");
          if (searchInput) {
            const tab = document.querySelector(
              '.nav-tab[data-section="patients"]',
            );
            if (tab) tab.click();

            setTimeout(() => {
              searchInput.focus();
              searchInput.select();
            }, 300);
          }
        }

        /**
         * Focus search input
         */
        focusSearch() {
          const searchInput = document.getElementById("patientSearch");
          if (searchInput) {
            searchInput.focus();
            searchInput.select();
          }
        }

        /**
         * Navigate to specific section
         */
        navigateToSection(sectionId) {
          const tab = document.querySelector(
            `.nav-tab[data-section="${sectionId}"]`,
          );
          if (tab) tab.click();
        }

        /**
         * Quick save based on current section
         */
        quickSave() {
          const active = document.querySelector(".section.active").id;

          switch (active) {
            case "records":
              this.saveAsDraft();
              break;
            case "patients":
              const pm = document.getElementById("patientModal");
              if (pm?.classList.contains("show")) {
                this.savePatient();
              } else {
                this.showToast(
                  "Abra o cadastro de paciente para salvar",
                  "info",
                );
              }
              break;
            default:
              this.showToast(
                "Nenhum conteúdo para salvar na seção atual",
                "info",
              );
          }
        }

        /**
         * Show confirmation dialog
         */
        showConfirm(title, message, callback) {
          document.getElementById("confirmTitle").textContent = title;
          document.getElementById("confirmMessage").innerHTML = message;
          this.confirmCallback = callback;

          const modal = document.getElementById("confirmModal");
          modal.classList.add("show");
          modal.setAttribute("aria-hidden", "false");
        }

        /**
         * Close confirmation modal
         */
        closeConfirmModal() {
          const modal = document.getElementById("confirmModal");
          modal.classList.remove("show");
          modal.setAttribute("aria-hidden", "true");
          this.confirmCallback = null;
        }

        /**
         * Execute confirmed action
         */
        async confirmAction() {
          if (this.confirmCallback) {
            await this.confirmCallback();
          }
          this.closeConfirmModal();
        }

        /**
         * Close modal by element
         */
        closeModal(modal) {
          modal.classList.remove("show");
          modal.setAttribute("aria-hidden", "true");
        }

        /**
         * Close all open modals
         */
        closeAllModals() {
          document
            .querySelectorAll(".modal-overlay.show")
            .forEach((m) => this.closeModal(m));
        }

        /**
         * Set default date and time for records
         */
        setDefaultDateTime() {
          const now = new Date();
          now.setMinutes(now.getMinutes() - now.getTimezoneOffset());

          const recordDate = document.getElementById("recordDate");
          if (recordDate) {
            recordDate.value = now.toISOString().slice(0, 16);
          }
        }

        /**
         * Show toast notification
         */
        showToast(message, type = "success", duration = 4000) {
          // Remove existing toast
          const existing = document.querySelector(".toast");
          if (existing) existing.remove();

          // Create new toast
          const toast = document.createElement("div");
          toast.className = `toast ${type}`;

          const icons = {
            success: "check",
            error: "times",
            warning: "exclamation-triangle",
            info: "info-circle",
          };

          const icon = icons[type] || "info-circle";

          toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas fa-${icon}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-message">${message}</div>
                    </div>
                `;

          document.body.appendChild(toast);

          // Animate in
          setTimeout(() => toast.classList.add("show"), 100);

          // Animate out and remove
          setTimeout(() => {
            toast.classList.remove("show");
            setTimeout(() => {
              if (toast.parentNode) {
                document.body.removeChild(toast);
              }
            }, 300);
          }, duration);
        }

        /**
         * Toggle AI Assistant functionality
         */
        async toggleAIAssistant() {
          const btn = document.getElementById("aiToggleBtn");
          if (btn) {
            btn.classList.add("loading");
            btn.disabled = true;
          }

          try {
            this.aiAssistantActive = !this.aiAssistantActive;
            localStorage.setItem(
              "aiAssistantActive",
              JSON.stringify(this.aiAssistantActive),
            );

            // Simulate activation/deactivation
            await new Promise((resolve) => setTimeout(resolve, 1500));

            if (this.aiAssistantActive) {
              this.showToast("IA Assistente ativada com sucesso!", "success");
              if (btn) {
                btn.innerHTML =
                  '<i class="fas fa-brain" aria-hidden="true"></i> Desativar IA';
                btn.classList.remove("primary");
                btn.classList.add("warning");
              }
            } else {
              this.showToast("IA Assistente desativada", "info");
              if (btn) {
                btn.innerHTML =
                  '<i class="fas fa-brain" aria-hidden="true"></i> Ativar IA';
                btn.classList.remove("warning");
                btn.classList.add("primary");
              }
            }

            this.trackEvent("ai_assistant_toggled", {
              active: this.aiAssistantActive,
              timestamp: new Date().toISOString(),
            });
          } catch (error) {
            this.handleError(error, "Alternar IA Assistente");
          } finally {
            if (btn) {
              btn.classList.remove("loading");
              btn.disabled = false;
            }
          }
        }

        /**
         * Open Analytics modal
         */
        openAnalytics() {
          const modal = document.getElementById("analyticsModal");
          if (modal) {
            modal.classList.add("show");
            modal.setAttribute("aria-hidden", "false");

            // Load analytics data
            this.loadAnalyticsData();

            this.trackEvent("analytics_opened", {
              timestamp: new Date().toISOString(),
            });
          }
        }

        /**
         * Load analytics data
         */
        loadAnalyticsData() {
          const analyticsData = {
            events: JSON.parse(
              sessionStorage.getItem("medicalApp_events") || "[]",
            ),
            performance: Object.fromEntries(this.performanceMetrics),
            patients: this.patients.length,
            consultations: Math.floor(Math.random() * 200) + 50,
            prescriptions: Math.floor(Math.random() * 100) + 20,
          };

          const container = document.getElementById("analyticsData");
          if (container) {
            container.innerHTML = `
                        <strong>Eventos do Sistema:</strong><br>
                        ${analyticsData.events
                          .slice(-10)
                          .map(
                            (e) =>
                              `• ${e.name} - ${new Date(e.timestamp).toLocaleString("pt-BR")}`,
                          )
                          .join("<br>")}<br><br>

                        <strong>Métricas de Performance:</strong><br>
                        ${Object.entries(analyticsData.performance)
                          .map(([k, v]) => `• ${k}: ${Math.round(v)}ms`)
                          .join("<br>")}<br><br>

                        <strong>Estatísticas Gerais:</strong><br>
                        • Pacientes cadastrados: ${analyticsData.patients}<br>
                        • Consultas realizadas: ${analyticsData.consultations}<br>
                        • Prescrições emitidas: ${analyticsData.prescriptions}
                    `;
          }
        }

        /**
         * Close analytics modal
         */
        closeAnalyticsModal() {
          const modal = document.getElementById("analyticsModal");
          if (modal) {
            modal.classList.remove("show");
            modal.setAttribute("aria-hidden", "true");
          }
        }

        /**
         * Export analytics data
         */
        exportAnalytics() {
          const data = {
            timestamp: new Date().toISOString(),
            events: JSON.parse(
              sessionStorage.getItem("medicalApp_events") || "[]",
            ),
            performance: Object.fromEntries(this.performanceMetrics),
            patients: this.patients.length,
            dashboardMetrics: this.dashboardMetrics,
          };

          const dataStr = JSON.stringify(data, null, 2);
          const dataUri =
            "data:application/json;charset=utf-8," +
            encodeURIComponent(dataStr);

          const exportFileDefaultName = `prontuario_analytics_${new Date().toISOString().split("T")[0]}.json`;

          const linkElement = document.createElement("a");
          linkElement.setAttribute("href", dataUri);
          linkElement.setAttribute("download", exportFileDefaultName);
          linkElement.click();

          this.showToast(
            "Dados de analytics exportados com sucesso!",
            "success",
          );
          this.trackEvent("analytics_exported", {
            timestamp: new Date().toISOString(),
          });
        }

        /**
         * Configure backup settings
         */
        async configureBackup() {
          const currentConfig = this.backupConfig;

          this.showConfirm(
            "Configurar Backup",
            `
                    <div style="text-align:left">
                        <p><strong>Configurações atuais:</strong></p>
                        <ul style="margin:1rem 0">
                            <li>Status: ${currentConfig.enabled ? "Ativo" : "Inativo"}</li>
                            <li>Intervalo: ${currentConfig.interval}</li>
                            <li>Local: ${currentConfig.location}</li>
                        </ul>
                        <p>Deseja ativar o backup automático em nuvem?</p>
                    </div>
                    `,
            async () => {
              try {
                this.backupConfig.enabled = !this.backupConfig.enabled;
                localStorage.setItem(
                  "backupConfig",
                  JSON.stringify(this.backupConfig),
                );

                if (this.backupConfig.enabled) {
                  this.showToast("Backup automático ativado!", "success");
                  // Simulate first backup
                  setTimeout(() => {
                    this.showToast(
                      "Primeiro backup realizado com sucesso",
                      "info",
                    );
                  }, 2000);
                } else {
                  this.showToast("Backup automático desativado", "warning");
                }

                this.trackEvent("backup_configured", {
                  enabled: this.backupConfig.enabled,
                  timestamp: new Date().toISOString(),
                });
              } catch (error) {
                this.handleError(error, "Configurar backup");
              }
            },
          );
        }

        /**
         * Run system diagnostics
         */
        runSystemDiagnostics() {
          this.showToast("Executando diagnósticos do sistema...", "info");

          setTimeout(() => {
            const diagnostics = {
              Conectividade: navigator.onLine ? "OK" : "Erro",
              "Bird ID": this.birdIdStatus?.valid ? "OK" : "Aviso",
              "Base de Dados": "OK",
              Performance: this.getPerformanceStatus(),
              Memória: this.getMemoryStatus(),
              LocalStorage: this.getStorageStatus(),
            };

            let html =
              '<div style="text-align:left"><strong>Resultado dos Diagnósticos:</strong><br><br>';
            Object.entries(diagnostics).forEach(([key, value]) => {
              const icon =
                value === "OK" ? "✅" : value === "Aviso" ? "⚠️" : "❌";
              html += `${icon} <strong>${key}:</strong> ${value}<br>`;
            });
            html += "</div>";

            this.showToast(html, "success", 8000);

            this.trackEvent("diagnostics_run", {
              results: diagnostics,
              timestamp: new Date().toISOString(),
            });
          }, 2000);
        }

        /**
         * Get performance status
         */
        getPerformanceStatus() {
          const values = Array.from(this.performanceMetrics.values());
          if (values.length === 0) return "N/A";

          const average = values.reduce((a, b) => a + b, 0) / values.length;

          if (average < 1000) return "Excelente";
          if (average < 2000) return "Bom";
          if (average < 5000) return "Lento";
          return "Crítico";
        }

        /**
         * Get memory status
         */
        getMemoryStatus() {
          try {
            if ("memory" in performance) {
              const memory = performance.memory;
              const used = Math.round(memory.usedJSHeapSize / 1048576); // MB
              const limit = Math.round(memory.jsHeapSizeLimit / 1048576); // MB

              if (used / limit < 0.7) return `OK (${used}MB/${limit}MB)`;
              if (used / limit < 0.9) return `Aviso (${used}MB/${limit}MB)`;
              return `Crítico (${used}MB/${limit}MB)`;
            }
            return "N/A";
          } catch (e) {
            return "N/A";
          }
        }

        /**
         * Get storage status
         */
        getStorageStatus() {
          try {
            const testKey = "storage_test";
            localStorage.setItem(testKey, "test");
            localStorage.removeItem(testKey);

            const used = JSON.stringify(localStorage).length;
            const usedKB = Math.round(used / 1024);

            if (usedKB < 1000) return `OK (${usedKB}KB)`;
            if (usedKB < 3000) return `Aviso (${usedKB}KB)`;
            return `Crítico (${usedKB}KB)`;
          } catch (e) {
            return "Erro";
          }
        }

        /**
         * Load AI Assistant state
         */
        loadAIAssistantState() {
          try {
            const saved = localStorage.getItem("aiAssistantActive");
            this.aiAssistantActive = saved ? JSON.parse(saved) : false;

            const btn = document.getElementById("aiToggleBtn");
            if (btn && this.aiAssistantActive) {
              btn.innerHTML =
                '<i class="fas fa-brain" aria-hidden="true"></i> Desativar IA';
              btn.classList.remove("primary");
              btn.classList.add("warning");
            }
          } catch (e) {
            this.aiAssistantActive = false;
          }
        }

        /**
         * Load backup configuration
         */
        loadBackupConfig() {
          try {
            const saved = localStorage.getItem("backupConfig");
            if (saved) {
              this.backupConfig = {
                ...this.backupConfig,
                ...JSON.parse(saved),
              };
            }
          } catch (e) {
            // Use default config
          }
        }

        /**
         * Validate CPF (Brazilian document)
         */
        validateCPF(cpf) {
          const cleaned = String(cpf).replace(/\D/g, "");

          if (cleaned.length !== 11 || /^(\d)\1{10}$/.test(cleaned)) {
            return false;
          }

          // Validate first digit
          let sum = 0;
          for (let i = 0; i < 9; i++) {
            sum += parseInt(cleaned.charAt(i), 10) * (10 - i);
          }
          let remainder = (sum * 10) % 11;
          if (remainder === 10 || remainder === 11) remainder = 0;
          if (remainder !== parseInt(cleaned.charAt(9), 10)) return false;

          // Validate second digit
          sum = 0;
          for (let i = 0; i < 10; i++) {
            sum += parseInt(cleaned.charAt(i), 10) * (11 - i);
          }
          remainder = (sum * 10) % 11;
          if (remainder === 10 || remainder === 11) remainder = 0;

          return remainder === parseInt(cleaned.charAt(10), 10);
        }

        /**
         * Validate email address
         */
        validateEmail(email) {
          const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return regex.test(email);
        }

        /**
         * Escape HTML to prevent XSS
         */
        escapeHtml(text) {
          const div = document.createElement("div");
          div.textContent = text || "";
          return div.innerHTML;
        }

        /**
         * Escape JavaScript string
         */
        escapeJsString(str) {
          return String(str || "")
            .replace(/\\/g, "\\\\")
            .replace(/'/g, "\\'")
            .replace(/\n/g, "\\n")
            .replace(/\r/g, "\\r");
        }

        /**
         * Get safe initial for avatar
         */
        safeInitial(name) {
          const trimmed = String(name || "").trim();
          return trimmed ? trimmed.charAt(0).toUpperCase() : "?";
        }

        /**
         * Get patient avatar color
         */
        getPatientColor(name) {
          const colors = [
            "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
            "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
            "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
            "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
            "linear-gradient(135deg, #fa709a 0%, #fee140 100%)",
            "linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)",
            "linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)",
            "linear-gradient(135deg, #ff8a80 0%, #ea80fc 100%)",
          ];

          // Generate hash from name
          const hash = String(name || "")
            .split("")
            .reduce((acc, char) => {
              acc = (acc << 5) - acc + char.charCodeAt(0);
              return acc & acc; // Convert to 32-bit integer
            }, 0);

          return colors[Math.abs(hash) % colors.length];
        }

        /**
         * Get relative time string
         */
        getRelativeTime(date) {
          const now = new Date();
          const diffSeconds = Math.floor((now - date) / 1000);

          if (diffSeconds < 60) return "há poucos segundos";
          if (diffSeconds < 3600)
            return `há ${Math.floor(diffSeconds / 60)} minutos`;
          if (diffSeconds < 86400)
            return `há ${Math.floor(diffSeconds / 3600)} horas`;
          return `há ${Math.floor(diffSeconds / 86400)} dias`;
        }

        /**
         * Get local template content
         */
        getLocalTemplate(templateType) {
          const templates = {
            custom: `EVOLUÇÃO MÉDICA PERSONALIZADA

Data: ${new Date().toLocaleDateString("pt-BR")}
Horário: ${new Date().toLocaleTimeString("pt-BR")}
Paciente: ${this.currentPatient?.nome || "____"}

MOTIVO DA CONSULTA:
_____________________________________

HISTÓRIA CLÍNICA:
_____________________________________

EXAME FÍSICO:
_____________________________________

AVALIAÇÃO E CONDUTA:
_____________________________________

ORIENTAÇÕES:
_____________________________________

RETORNO:
_____________________________________

Dr. Matheus Jorge Assali
CRM/SP - Nefrologia`,

            primeira_consulta: `PRIMEIRA CONSULTA NEFROLÓGICA

Data: ${new Date().toLocaleDateString("pt-BR")}
Paciente: ${this.currentPatient?.nome || "____"}
Idade: ${this.currentPatient?.idade || "____"} anos
Sexo: ${this.currentPatient?.sexo || "____"}

QUEIXA PRINCIPAL:
_____________________________________

HISTÓRIA DA DOENÇA ATUAL:
_____________________________________

ANTECEDENTES PESSOAIS:
_____________________________________

MEDICAÇÕES EM USO:
_____________________________________

EXAME FÍSICO:
PA: ___x___mmHg | FC: ___bpm | Peso: ___kg
Estado geral: □ BEG □ REG □ MEG
Edema: □ Ausente □ Presente (___/4+)

AVALIAÇÃO:
_____________________________________

CONDUTA:
_____________________________________

RETORNO: ___________

Dr. Matheus Jorge Assali
CRM/SP - Nefrologia`,

            evolucao_hd: `EVOLUÇÃO HEMODIÁLISE

Data: ${new Date().toLocaleDateString("pt-BR")}
Paciente: ${this.currentPatient?.nome || "____"}
Sessão: _____ | Peso seco: _____kg

PRÉ-DIÁLISE:
Peso: _____kg | PA: ___x___mmHg | FC: ___bpm
UF programada: _____ml
Acesso vascular: □ FAV □ Cateter □ Prótese

INTERCORRÊNCIAS DURANTE A SESSÃO:
□ Hipotensão □ Cãibras □ Cefaleia □ Outras: _____

PÓS-DIÁLISE:
Peso: _____kg | PA: ___x___mmHg | FC: ___bpm
UF realizada: _____ml | Kt/V: _____

PRESCRIÇÃO DIALÍTICA:
Frequência: ___x/semana | Tempo: ___h
Banho: _____ | Fluxo: _____ml/min

CONDUTA:
_____________________________________

Dr. Matheus Jorge Assali
CRM/SP - Nefrologia`,

            soap: `EVOLUÇÃO MÉDICA - SOAP

Data: ${new Date().toLocaleDateString("pt-BR")}
Paciente: ${this.currentPatient?.nome || "____"}

SUBJETIVO (S):
_____________________________________

OBJETIVO (O):
Sinais vitais: PA ___x___mmHg | FC ___bpm | T ___°C
Exame físico:
_____________________________________

Exames complementares:
_____________________________________

AVALIAÇÃO (A):
_____________________________________

PLANO (P):
_____________________________________

Dr. Matheus Jorge Assali
CRM/SP - Nefrologia`,
          };

          return templates[templateType] || templates.custom;
        }

        /**
         * Record performance metric
         */
        recordPerformance(action, duration) {
          this.performanceMetrics.set(action, duration);

          // Keep only last 100 metrics
          if (this.performanceMetrics.size > 100) {
            const entries = Array.from(this.performanceMetrics.entries());
            const recent = entries.slice(-50);
            this.performanceMetrics.clear();
            recent.forEach(([key, value]) => {
              this.performanceMetrics.set(key, value);
            });
          }
        }

        /**
         * Track user events
         */
        trackEvent(name, data = {}) {
          const event = {
            name,
            data,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            url: window.location.href,
          };

          const events = JSON.parse(
            sessionStorage.getItem("medicalApp_events") || "[]",
          );
          events.push(event);

          // Keep only last 100 events
          if (events.length > 100) {
            events.splice(0, events.length - 100);
          }

          sessionStorage.setItem("medicalApp_events", JSON.stringify(events));
        }

        /**
         * Save metrics to storage
         */
        saveMetrics() {
          const metrics = {
            performance: Object.fromEntries(this.performanceMetrics),
            events: JSON.parse(
              sessionStorage.getItem("medicalApp_events") || "[]",
            ),
            timestamp: new Date().toISOString(),
          };

          localStorage.setItem("medicalApp_metrics", JSON.stringify(metrics));
        }

        /**
         * Setup performance monitoring
         */
        setupPerformanceMonitoring() {
          // Monitor navigation timing
          if ("performance" in window && performance.getEntriesByType) {
            const navigation = performance.getEntriesByType("navigation")[0];
            if (navigation) {
              this.recordPerformance(
                "page_load",
                navigation.loadEventEnd - navigation.fetchStart,
              );
            }
          }

          // Monitor resource loading
          if ("PerformanceObserver" in window) {
            try {
              const observer = new PerformanceObserver((list) => {
                for (const entry of list.getEntries()) {
                  if (entry.entryType === "measure") {
                    this.recordPerformance(entry.name, entry.duration);
                  }
                }
              });
              observer.observe({ entryTypes: ["measure"] });
            } catch (e) {
              // Fallback if PerformanceObserver is not supported
            }
          }
        }

        /**
         * Handle errors consistently
         */
        handleError(error, context = "") {
          const message =
            error?.message ||
            (typeof error === "string" ? error : "Erro inesperado");

          this.trackEvent("error", {
            context,
            message,
            stack: error?.stack || "",
            timestamp: new Date().toISOString(),
          });

          const fullMessage = context ? `${context}: ${message}` : message;
          this.showToast(fullMessage, "error");

          // Log to console for debugging
          console.error(`[MedicalApp] ${fullMessage}`, error);
        }
      }

      // Initialize the application
      const app = new AdvancedMedicalSystem();

      // Setup global event handlers
      document.addEventListener("DOMContentLoaded", () => {
        if (app.initializeAdvancedFeatures) {
          app.initializeAdvancedFeatures();
        }
      });

      // Handle uncaught errors
      window.addEventListener("error", (event) => {
        const error = event.error || new Error("Erro desconhecido no sistema");
        app.handleError(error, "Sistema");
      });

      // Handle unhandled promise rejections
      window.addEventListener("unhandledrejection", (event) => {
        const reason = event.reason || new Error("Promise rejeitada");
        app.handleError(reason, "Promise");
        event.preventDefault();
      });

      // Make app globally available
      window.medicalApp = app;
    </script>

    <!-- Advanced Features Script -->
    <script>
      "use strict";

      /**
       * Setup accessibility features
       */
      AdvancedMedicalSystem.prototype.setupAccessibilityFeatures = function () {
        // Keyboard navigation for patient cards
        document.addEventListener("keydown", (e) => {
          if (
            e.target.classList &&
            e.target.classList.contains("patient-card")
          ) {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              e.target.click();
            }
          }
        });

        // Auto-focus for modals
        const modalObserver = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (
              mutation.type === "attributes" &&
              mutation.attributeName === "class"
            ) {
              const modal = mutation.target;
              if (modal.classList.contains("show")) {
                const focusElement = modal.querySelector(
                  "input, select, textarea, button",
                );
                if (focusElement) {
                  setTimeout(() => focusElement.focus(), 100);
                }
              }
            }
          });
        });

        document.querySelectorAll(".modal-overlay").forEach((modal) => {
          modalObserver.observe(modal, { attributes: true });
        });

        this.setupARIALiveRegions();
      };

      /**
       * Setup ARIA live regions for screen readers
       */
      AdvancedMedicalSystem.prototype.setupARIALiveRegions = function () {
        const liveRegion = document.createElement("div");
        liveRegion.setAttribute("aria-live", "polite");
        liveRegion.setAttribute("aria-atomic", "true");
        liveRegion.style.position = "absolute";
        liveRegion.style.left = "-10000px";
        liveRegion.style.width = "1px";
        liveRegion.style.height = "1px";
        liveRegion.style.overflow = "hidden";
        document.body.appendChild(liveRegion);

        this.liveRegion = liveRegion;
      };

      /**
       * Announce message to screen readers
       */
      AdvancedMedicalSystem.prototype.announceToScreenReader = function (
        message,
      ) {
        if (this.liveRegion) {
          this.liveRegion.textContent = message;
        }
      };

      /**
       * Setup network monitoring
       */
      AdvancedMedicalSystem.prototype.setupNetworkMonitoring = function () {
        const updateConnectivityStatus = () => {
          const statusElement = document.getElementById("connectivityStatus");
          if (!statusElement) return;

          if (navigator.onLine) {
            statusElement.innerHTML =
              '<i class="fas fa-check-circle" aria-hidden="true"></i> Online';
            statusElement.style.color = "var(--success-700)";
          } else {
            statusElement.innerHTML =
              '<i class="fas fa-exclamation-triangle" aria-hidden="true"></i> Offline';
            statusElement.style.color = "var(--error-700)";
            this.showToast(
              "Conexão perdida. Algumas funcionalidades podem não funcionar.",
              "warning",
            );
          }
        };

        window.addEventListener("online", updateConnectivityStatus);
        window.addEventListener("offline", updateConnectivityStatus);
        updateConnectivityStatus();
      };

      /**
       * Initialize advanced features
       */
      AdvancedMedicalSystem.prototype.initializeAdvancedFeatures = function () {
        this.setupAccessibilityFeatures();
        this.setupNetworkMonitoring();

        // Auto-refresh dashboard every 10 minutes
        setInterval(
          () => {
            const activeDashboard = document.querySelector(
              '.nav-tab.active[data-section="dashboard"]',
            );
            if (activeDashboard) {
              this.loadDashboardData();
            }
          },
          10 * 60 * 1000,
        );

        // Check Bird ID status every 5 minutes
        setInterval(
          () => {
            this.checkBirdIdStatus();
          },
          5 * 60 * 1000,
        );

        // Setup service worker for offline support
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.register("/sw.js").catch(() => {
            // Silently fail if service worker is not available
          });
        }
      };
    </script>
  </body>
</html>
